<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>NEXUS STUDY ¬∑ flowstate 2026</title>
  <!-- Google Fonts & Iconos minimalistas (Lucide) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <!-- Lucide icons (feather style) -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- part√≠culas (librer√≠a ligera para fondo animado) -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <style>
    /* RESET + VARIABLES TEMA OSCURO (glass futurista) */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    :root {
      --bg-dark: #0b0c0f;
      --glass-bg: rgba(18, 22, 30, 0.6);
      --glass-border: rgba(80, 90, 120, 0.25);
      --card-bg: rgba(25, 30, 40, 0.7);
      --primary-glow: #00e0ff;
      --accent-soft: #9f9fff;
      --text-primary: #f0f3f8;
      --text-secondary: #aab3cc;
      --success: #2ee6a8;
      --warning: #ffcc66;
      --danger: #ff7791;
      --level-badge: #c096ff;
      --shadow-heavy: 0 20px 40px -10px rgba(0,0,0,0.7);
      --blur-amount: 16px;
    }

    /* tema claro (toggle) */
    body.light {
      --bg-dark: #eef2f6;
      --glass-bg: rgba(255, 255, 255, 0.6);
      --glass-border: rgba(150, 160, 180, 0.3);
      --card-bg: rgba(255, 255, 255, 0.7);
      --text-primary: #121826;
      --text-secondary: #2f374b;
      --shadow-heavy: 0 20px 35px -8px rgba(0,20,40,0.2);
    }

    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      transition: background 0.3s ease, color 0.2s ease;
      position: relative;
      backdrop-filter: blur(2px);
      font-weight: 400;
      line-height: 1.5;
    }

    /* pantalla login */
    .login-screen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      background: var(--bg-dark);
      backdrop-filter: blur(20px);
    }
    .login-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 60px;
      padding: 3rem 2.5rem;
      width: 90%;
      max-width: 420px;
      box-shadow: var(--shadow-heavy);
      text-align: center;
      animation: floatIn 0.5s ease;
    }
    @keyframes floatIn {
      0% { opacity: 0; transform: scale(0.95) translateY(20px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }
    .login-card h2 {
      font-size: 2.2rem;
      font-weight: 600;
      background: linear-gradient(145deg, #fff, #b0d0ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.4rem;
    }
    .login-sub {
      color: var(--text-secondary);
      margin-bottom: 2.2rem;
    }
    .password-field {
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--glass-border);
      border-radius: 80px;
      padding: 16px 24px;
      width: 100%;
      color: var(--text-primary);
      font-size: 1.1rem;
      outline: none;
      margin-bottom: 1.8rem;
      transition: 0.2s;
    }
    .password-field:focus {
      border-color: var(--primary-glow);
      box-shadow: 0 0 0 4px rgba(0,224,255,0.15);
    }
    .login-btn {
      background: linear-gradient(145deg, #1f2a45, #0f172a);
      border: none;
      padding: 16px 32px;
      border-radius: 80px;
      font-weight: 700;
      font-size: 1.2rem;
      color: white;
      width: 100%;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 10px 0 #0b0f1c;
      transition: 0.1s ease;
    }
    .login-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 14px 0 #0b0f1c, 0 0 30px var(--primary-glow);
    }
    .login-btn:active {
      transform: translateY(5px);
      box-shadow: 0 5px 0 #0b0f1c;
    }

    /* app oculta inicialmente */
    #app {
      display: none;
    }

    /* part√≠culas fondo animado profesional */
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
      pointer-events: none;
      opacity: 0.45;
    }

    /* contenedor principal glass */
    .glass-dashboard {
      max-width: 1300px;
      margin: 2rem 1.5rem;
      padding: 2rem 2rem 2.8rem;
      background: var(--glass-bg);
      backdrop-filter: blur(var(--blur-amount));
      -webkit-backdrop-filter: blur(var(--blur-amount));
      border: 1px solid var(--glass-border);
      border-radius: 48px 48px 48px 48px;
      box-shadow: var(--shadow-heavy);
      transition: background 0.3s ease;
      position: relative;
      z-index: 2;
    }

    /* responsive */
    @media (max-width: 700px) {
      .glass-dashboard {
        margin: 1rem 0.8rem;
        padding: 1.5rem 1rem;
        border-radius: 32px;
      }
    }

    /* header premium */
    .app-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2.8rem;
    }
    .logo-area {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .logo-icon {
      background: rgba(0, 224, 255, 0.1);
      border: 1px solid rgba(0, 224, 255, 0.3);
      padding: 10px;
      border-radius: 24px;
      color: var(--primary-glow);
    }
    .logo-text h1 {
      font-weight: 600;
      font-size: 1.8rem;
      letter-spacing: -0.02em;
      background: linear-gradient(130deg, #fff, #b4c8ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    body.light .logo-text h1 {
      background: linear-gradient(130deg, #0f1a2f, #2d3b66);
      -webkit-background-clip: text;
    }
    .badge {
      background: rgba(255,255,255,0.05);
      padding: 8px 18px;
      border-radius: 80px;
      border: 1px solid rgba(255,255,255,0.1);
      font-size: 0.9rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    /* toggle tema + extras */
    .action-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }
    .glass-button {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(8px);
      padding: 10px 20px;
      border-radius: 40px;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }
    .glass-button:hover {
      background: rgba(120, 160, 255, 0.2);
      border-color: var(--primary-glow);
      transform: scale(1.02);
      box-shadow: 0 0 15px rgba(0,224,255,0.2);
    }

    /* estad√≠sticas dashboard */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 36px;
    }
    .stat-card {
      background: var(--card-bg);
      backdrop-filter: blur(4px);
      border-radius: 32px;
      padding: 22px 16px;
      border: 1px solid var(--glass-border);
      box-shadow: 0 10px 20px -8px rgba(0,0,0,0.4);
      transition: all 0.2s;
    }
    .stat-card:hover {
      border-color: var(--primary-glow);
      transform: translateY(-4px);
    }
    .stat-title {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      display: flex;
      gap: 6px;
      align-items: center;
    }
    .stat-value {
      font-size: 2.7rem;
      font-weight: 700;
      line-height: 1.1;
    }
    .progress-micro {
      height: 8px;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      margin-top: 16px;
      width: 100%;
      overflow: hidden;
    }
    .progress-micro-fill {
      height: 8px;
      background: linear-gradient(90deg, var(--success), var(--primary-glow));
      border-radius: 20px;
      width: 0%;
      transition: width 0.4s cubic-bezier(0.2, 0.9, 0.3, 1.1);
    }

    /* buscador + filtros */
    .search-filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 32px;
    }
    .search-box {
      flex: 2;
      min-width: 240px;
      background: rgba(0,0,0,0.2);
      border-radius: 60px;
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      padding: 4px 4px 4px 20px;
      backdrop-filter: blur(8px);
    }
    .search-box i {
      color: var(--text-secondary);
    }
    .search-box input {
      background: transparent;
      border: none;
      padding: 14px 12px;
      width: 100%;
      color: var(--text-primary);
      font-size: 1rem;
      outline: none;
    }
    .filter-select {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
      border-radius: 60px;
      padding: 0 20px;
      color: var(--text-primary);
      font-weight: 500;
      backdrop-filter: blur(8px);
      cursor: pointer;
      outline: none;
    }

    /* formulario a√±adir tarea */
    .task-input-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
      background: rgba(15, 20, 30, 0.4);
      backdrop-filter: blur(10px);
      border-radius: 80px;
      padding: 12px 20px;
      margin-bottom: 40px;
      border: 1px solid var(--glass-border);
    }
    .task-input-panel input, .task-input-panel select {
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--glass-border);
      border-radius: 40px;
      padding: 14px 18px;
      color: var(--text-primary);
      font-size: 0.95rem;
      flex: 1 1 160px;
      outline: none;
      transition: 0.15s;
    }
    .task-input-panel input:focus, .task-input-panel select:focus {
      border-color: var(--primary-glow);
      box-shadow: 0 0 0 3px rgba(0,224,255,0.1);
    }
    .task-input-panel button {
      background: linear-gradient(145deg, #1f2a45, #0f172a);
      border: none;
      padding: 14px 32px;
      border-radius: 40px;
      font-weight: 600;
      color: white;
      box-shadow: 0 6px 0 #0b0f1c;
      cursor: pointer;
      transition: all 0.1s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      border: 1px solid rgba(255,255,255,0.05);
    }
    .task-input-panel button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 0 #0b0f1c, 0 0 20px var(--primary-glow);
    }

    /* lista de tareas */
    .tasks-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 28px 0 20px;
    }
    .task-card {
      background: var(--card-bg);
      backdrop-filter: blur(12px);
      border-radius: 40px;
      padding: 18px 24px;
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
      animation: taskAppear 0.3s ease;
      transition: all 0.2s;
    }
    .task-card:hover {
      border-color: var(--primary-glow);
      box-shadow: 0 10px 25px -5px rgba(0,224,255,0.2);
      background: rgba(35, 45, 65, 0.8);
    }
    @keyframes taskAppear {
      0% { opacity: 0; transform: scale(0.96) translateY(8px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }
    .task-info {
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 2;
    }
    .task-title {
      font-weight: 600;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .task-meta {
      display: flex;
      gap: 16px;
      color: var(--text-secondary);
      font-size: 0.85rem;
      align-items: center;
    }
    .badge-materia {
      background: rgba(90, 120, 255, 0.2);
      padding: 6px 14px;
      border-radius: 40px;
      border-left: 3px solid var(--primary-glow);
      font-weight: 500;
    }
    .task-actions {
      display: flex;
      gap: 8px;
    }
    .icon-btn {
      background: transparent;
      border: 1px solid var(--glass-border);
      width: 44px;
      height: 44px;
      border-radius: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      cursor: pointer;
      transition: 0.15s;
    }
    .icon-btn:hover {
      background: var(--primary-glow);
      border-color: white;
      color: black;
      transform: scale(1.08);
    }
    .task-card.completed .task-title {
      text-decoration: line-through;
      opacity: 0.65;
    }
    .task-card.completed {
      background: rgba(50, 70, 90, 0.3);
    }

    /* mensaje motivacional */
    .motivation-box {
      background: linear-gradient(110deg, #0c1f2e, #14253b);
      border-radius: 60px;
      padding: 22px 32px;
      margin: 20px 0 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid #2d4b6e;
      font-size: 1.25rem;
      font-weight: 500;
      box-shadow: 0 0 30px rgba(0,160,255,0.15);
    }
    .confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    /* micro: sonido soft (oculto) */
    #taskSound {
      display: none;
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN con contrase√±a Papucholangas -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h2>nexus flow</h2>
      <div class="login-sub">acceso privado ¬∑ estudio 2026</div>
      <input type="password" id="passwordInput" class="password-field" placeholder="contrase√±a" autofocus>
      <button class="login-btn" id="loginBtn">ENTRAR AL DASHBOARD</button>
      <div style="margin-top: 20px; color: var(--text-secondary); font-size:0.85rem; opacity:0.7">demo: Papucholangas</div>
    </div>
  </div>

  <!-- APLICACI√ìN PRINCIPAL (oculta hasta login correcto) -->
  <div id="app">
    <div id="particles-js"></div> <!-- fondo animado profesional -->

    <!-- confetti overlay -->
    <canvas id="confettiCanvas" class="confetti-canvas" style="display: none;"></canvas>
    <audio id="taskSound" src="data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gR2VtaW5pU291bmRzLnByb2Zlc3Npb25hbC5tcDMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQxAAAA18a4QaAQAADp8uFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" type="audio/mpeg"></audio>

    <main class="glass-dashboard">
      <!-- header con nivel y modo toggle -->
      <div class="app-header">
        <div class="logo-area">
          <div class="logo-icon"><i data-lucide="sparkles" width="28"></i></div>
          <div class="logo-text"><h1>nexus flow</h1></div>
        </div>
        <div class="action-bar">
          <span class="badge"><i data-lucide="flame"></i> <span id="streakDisplay">0</span> ¬∑ racha</span>
          <span class="badge"><i data-lucide="zap"></i> nivel <span id="levelDisplay">1</span></span>
          <span class="badge"><i data-lucide="star"></i> <span id="pointsDisplay">0</span> pts</span>
          <div class="glass-button" id="themeToggle"><i data-lucide="moon"></i> claro/oscuro</div>
        </div>
      </div>

      <!-- dashboard stats -->
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-title"><i data-lucide="check-circle" width="18"></i> completadas</div><div class="stat-value" id="completedCount">0</div><div class="progress-micro"><div class="progress-micro-fill" id="globalProgressBar" style="width:0%"></div></div></div>
        <div class="stat-card"><div class="stat-title"><i data-lucide="list-todo"></i> total tareas</div><div class="stat-value" id="totalTasks">0</div></div>
        <div class="stat-card"><div class="stat-title"><i data-lucide="layers"></i> progreso por mate</div><div class="stat-value" style="font-size:1.2rem;" id="subjectProgressText">‚ö° 0%</div><div class="progress-micro"><div class="progress-micro-fill" id="subjectProgressFill" style="width:0%"></div></div></div>
        <div class="stat-card"><div class="stat-title"><i data-lucide="gift"></i> recompensa</div><div class="stat-value" style="font-size:1.4rem;" id="rewardBadge">üîí novato</div></div>
      </div>

      <!-- filtro y b√∫squeda -->
      <div class="search-filter-row">
        <div class="search-box"><i data-lucide="search" width="18"></i><input type="text" id="searchInput" placeholder="Buscar tarea..."></div>
        <select class="filter-select" id="filterSubject">
          <option value="*">Todas las materias</option>
          <option value="Matem√°ticas">üìê Matem√°ticas</option>
          <option value="F√≠sica">‚ö° F√≠sica</option>
          <option value="Castellano">üìñ Castellano</option>
          <option value="Bioqu√≠mica">üß¨ Bioqu√≠mica</option>
          <option value="Filosof√≠a">ü§î Filosof√≠a</option>
          <option value="Ingl√©s">üåé Ingl√©s</option>
          <option value="Taller">üõ†Ô∏è Taller</option>
          <option value="Baloncesto">üèÄ Baloncesto</option>
          <option value="otro">‚ú® otra</option>
        </select>
      </div>

      <!-- input nueva tarea -->
      <div class="task-input-panel">
        <select id="materiaSelect">
          <option>Matem√°ticas</option><option>F√≠sica</option><option>Castellano</option><option>Bioqu√≠mica</option>
          <option>Filosof√≠a</option><option>Ingl√©s</option><option>Taller</option><option>Baloncesto</option><option>otro</option>
        </select>
        <input type="text" id="taskInput" placeholder="Nombre de la tarea">
        <input type="date" id="dateInput">
        <button id="addTaskBtn"><i data-lucide="plus"></i> crear tarea</button>
      </div>

      <!-- mensaje motivacional din√°mico -->
      <div class="motivation-box" id="motivationMsg">üöÄ ¬°Inicia tu primera tarea!</div>

      <!-- lista de tareas -->
      <div id="tasksList" class="tasks-container"></div>

      <!-- espacio para recompensas virtuales extra -->
      <div style="text-align: right; color: var(--text-secondary); font-size:0.9rem; margin-top:10px" id="virtualRewardLine">‚≠ê desbloquea racha 7</div>
    </main>
  </div>

  <script type="module">
    // ========== CONFIG FIREBASE (modular CDN) ==========
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js';
    import { getDatabase, ref, push, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD8Z8M5TL-SU3oMFYULFaIzhBrD9yObXwo",
      authDomain: "papucholangas.firebaseapp.com",
      databaseURL: "https://papucholangas-default-rtdb.firebaseio.com",
      projectId: "papucholangas",
      storageBucket: "papucholangas.firebasestorage.app",
      messagingSenderId: "392558100266",
      appId: "1:392558100266:web:eb3a5313670bcafba96853"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tasksRef = ref(db, 'tareas');

    // ========== CONTROL DE ACCESO: CONTRASE√ëA "Papucholangas" ==========
    const loginScreen = document.getElementById('loginScreen');
    const appContainer = document.getElementById('app');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');

    function checkPassword() {
      if (passwordInput.value === 'Papucholangas') {
        loginScreen.style.display = 'none';
        appContainer.style.display = 'block';
        // Inicializar part√≠culas y todo despu√©s del login
        initParticles();
        // Cargar datos Firebase (ya est√° escuchando pero comenzamos despu√©s)
        setupFirebaseListener();
        // Ajustar tama√±o canvas confetti
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;
      } else {
        alert('Contrase√±a incorrecta');
      }
    }

    loginBtn.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkPassword(); });

    // ========== ESTADO GLOBAL Y VARIABLES ==========
    let allTasks = [];                // almac√©n para filtros
    let userLevel = 1;
    let userPoints = 0;
    let streak = 0;                   // racha diaria real (basada en completadas hoy)
    let lastCompletedDate = '';

    // elementos DOM (solo accesibles cuando app visible)
    const tasksDiv = document.getElementById('tasksList');
    const totalSpan = document.getElementById('totalTasks');
    const completedSpan = document.getElementById('completedCount');
    const streakSpan = document.getElementById('streakDisplay');
    const levelSpan = document.getElementById('levelDisplay');
    const pointsSpan = document.getElementById('pointsDisplay');
    const globalBar = document.getElementById('globalProgressBar');
    const motMsg = document.getElementById('motivationMsg');
    const rewardLine = document.getElementById('virtualRewardLine');
    const subjectProgressText = document.getElementById('subjectProgressText');
    const subjectProgressFill = document.getElementById('subjectProgressFill');
    const themeBtn = document.getElementById('themeToggle');
    const searchInput = document.getElementById('searchInput');
    const filterSubject = document.getElementById('filterSubject');
    const addBtn = document.getElementById('addTaskBtn');
    const taskInput = document.getElementById('taskInput');
    const materiaSelect = document.getElementById('materiaSelect');
    const dateInput = document.getElementById('dateInput');

    // sonido y confetti
    const sound = document.getElementById('taskSound');
    const confettiCanvas = document.getElementById('confettiCanvas');
    let confettiCtx = confettiCanvas.getContext('2d');
    let particles = [];

    // ========== FUNCIONES DE CONFETTI ==========
    function startConfetti() {
      confettiCanvas.style.display = 'block';
      for (let i=0; i<60; i++) particles.push({ x: Math.random()*window.innerWidth, y: -20, r: Math.random()*6+2, d: Math.random()*5+2, color: `hsl(${Math.random()*360},80%,60%)` });
      requestAnimationFrame(drawConfetti);
      setTimeout(() => { confettiCanvas.style.display = 'none'; particles = []; }, 2000);
    }
    function drawConfetti() {
      if (!confettiCanvas.style.display || confettiCanvas.style.display === 'none') return;
      confettiCtx.clearRect(0,0,window.innerWidth,window.innerHeight);
      particles.forEach(p => { p.y += p.d; if(p.y>window.innerHeight) p.y=-10; });
      particles.forEach(p => { confettiCtx.beginPath(); confettiCtx.arc(p.x, p.y, p.r, 0, Math.PI*2); confettiCtx.fillStyle = p.color; confettiCtx.fill(); });
      requestAnimationFrame(drawConfetti);
    }

    // ========== RACHA DIARIA REAL ==========
    function updateStreak(tasks) {
      const today = new Date().toDateString().split(' ')[1]+' '+new Date().getDate(); 
      const completedToday = tasks.filter(t => t.hecho && t.completedDate === today).length;
      if (completedToday > 0) {
        if (lastCompletedDate !== today) {
          streak++;
          lastCompletedDate = today;
        }
      } else {
        const yesterday = new Date(Date.now()-864e5).toDateString().split(' ')[1]+' '+ (new Date(Date.now()-864e5).getDate());
        if (lastCompletedDate && lastCompletedDate !== today && lastCompletedDate !== yesterday) streak = 0;
      }
      streakSpan.innerText = streak;
    }

    // ========== NIVEL Y PUNTOS ==========
    function updateLevelAndPoints(completedDelta = 0) {
      if (completedDelta > 0) userPoints += 10 * completedDelta;
      let newLevel = Math.floor(userPoints / 100) + 1;
      if (newLevel > userLevel) {
        userLevel = newLevel;
        startConfetti();
        motMsg.innerText = `üéâ ¬°SUBISTE A NIVEL ${userLevel}! SIGUE AS√ç üî•`;
      }
      levelSpan.innerText = userLevel;
      pointsSpan.innerText = userPoints;
    }

    // ========== RENDER TAREAS + FILTROS ==========
    function renderTasks(tasks) {
      allTasks = [...tasks];
      const searchTerm = searchInput.value.toLowerCase();
      const subjectFilter = filterSubject.value;

      let filtered = tasks.filter(t => t.texto.toLowerCase().includes(searchTerm));
      if (subjectFilter !== '*') filtered = filtered.filter(t => t.materia === subjectFilter);

      const total = filtered.length;
      const completed = filtered.filter(t => t.hecho).length;
      totalSpan.innerText = total;
      completedSpan.innerText = completed;
      const percent = total ? (completed/total)*100 : 0;
      globalBar.style.width = percent + '%';

      // progreso materia principal
      const subjectCounts = {};
      tasks.forEach(t => { if(!t.hecho) subjectCounts[t.materia] = (subjectCounts[t.materia]||0)+1; });
      const topSubject = Object.keys(subjectCounts).sort((a,b)=>subjectCounts[b]-subjectCounts[a])[0] || 'Ninguna';
      const totalSubj = tasks.filter(t=>t.materia===topSubject).length;
      const doneSubj = tasks.filter(t=>t.materia===topSubject && t.hecho).length;
      const subPercent = totalSubj? (doneSubj/totalSubj*100).toFixed(1):0;
      subjectProgressText.innerText = `${topSubject}: ${subPercent}%`;
      subjectProgressFill.style.width = subPercent + '%';

      // mensaje motivacional
      const messages = ['üß† Vas imparable', 'üöÄ Sigue rompiendo', 'üí° Un paso m√°s', 'üåü Cerca de la meta', '‚ö° Flow activado'];
      motMsg.innerText = messages[Math.floor(Math.random() * messages.length)] + (completed>0 ? ` (${completed} hoy)` : '');

      // recompensa virtual
      const rewards = ['üî∞ novato', '‚ö° foco', 'üî• racha', 'üíé √©lite', 'üèÜ leyenda'];
      rewardLine.innerText = `üéÅ ${rewards[Math.min(userLevel-1,4)]} ¬∑ siguiente nivel en ${100 - (userPoints%100)}pts`;

      // dibujar tareas
      tasksDiv.innerHTML = filtered.map(t => {
        const dateStr = t.fecha ? new Date(t.fecha).toLocaleDateString() : 'sin fecha';
        return `<div class="task-card ${t.hecho ? 'completed' : ''}" data-key="${t.key}">
          <div class="task-info">
            <div class="task-title"><span class="badge-materia">${t.materia}</span> ${t.texto}</div>
            <div class="task-meta"><span><i data-lucide="calendar" width="14"></i> ${dateStr}</span></div>
          </div>
          <div class="task-actions">
            <button class="icon-btn complete-btn" data-key="${t.key}" data-done="${t.hecho}"><i data-lucide="${t.hecho ? 'rotate-ccw' : 'check'}"></i></button>
            <button class="icon-btn edit-btn" data-key="${t.key}" data-text="${t.texto}" data-materia="${t.materia}" data-fecha="${t.fecha || ''}"><i data-lucide="pencil"></i></button>
            <button class="icon-btn delete-btn" data-key="${t.key}"><i data-lucide="trash-2"></i></button>
          </div>
        </div>`;
      }).join('');
      lucide.createIcons();

      // eventos botones
      document.querySelectorAll('.complete-btn').forEach(b => b.addEventListener('click', (e) => {
        const key = b.dataset.key; const done = b.dataset.done === 'true';
        update(ref(db, 'tareas/'+key), { hecho: !done });
        if (!done) {
          sound.play().catch(e=>{}); startConfetti();
          const today = new Date().toDateString().split(' ')[1]+' '+new Date().getDate();
          update(ref(db, 'tareas/'+key), { completedDate: today });
          updateLevelAndPoints(1);
        }
      }));
      document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', () => remove(ref(db, 'tareas/'+b.dataset.key))));
      document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', () => {
        const newText = prompt('Editar tarea:', b.dataset.text);
        if (newText) update(ref(db, 'tareas/'+b.dataset.key), { texto: newText });
      }));
    }

    // ========== FIREBASE REAL TIME ==========
    function setupFirebaseListener() {
      onValue(tasksRef, (snapshot) => {
        const tasks = [];
        snapshot.forEach(child => {
          tasks.push({ key: child.key, ...child.val() });
        });
        tasks.sort((a,b) => (a.fecha||'') > (b.fecha||'') ? 1 : -1);
        renderTasks(tasks);
        updateStreak(tasks);
      });
    }

    // ========== AGREGAR TAREA ==========
    addBtn.addEventListener('click', () => {
      const texto = taskInput.value.trim();
      if (!texto) return;
      const materia = materiaSelect.value;
      const fecha = dateInput.value || null;
      push(tasksRef, { texto, materia, fecha, hecho: false });
      taskInput.value = '';
    });

    // ========== TEMA CLARO/OSCURO ==========
    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('light');
      const icon = themeBtn.querySelector('i');
      icon.setAttribute('data-lucide', document.body.classList.contains('light') ? 'sun' : 'moon');
      lucide.createIcons();
    });

    // ========== INICIALIZAR FONDO PARTICULAS ==========
    function initParticles() {
      particlesJS('particles-js', {
        particles: { number: { value: 60 }, color: { value: '#4a80f0' }, opacity: { value: 0.3 }, size: { value: 2 }, line_linked: { enable: true, distance: 150, color: '#4a80f0', opacity: 0.2 }, move: { enable: true, speed: 0.8 } },
        interactivity: { detect_on: 'canvas', events: { onhover: { enable: true, mode: 'repulse' } } }
      });
    }

    // suscripci√≥n a filtros
    searchInput.addEventListener('input', () => renderTasks(allTasks));
    filterSubject.addEventListener('change', () => renderTasks(allTasks));

    window.addEventListener('resize', () => { confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; });
  </script>
  <script>lucide.createIcons();</script>
</body>
</html>

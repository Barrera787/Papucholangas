<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>TUTA & YOP ¬∑ estudio d√∫o din√°mico</title>
  <!-- Google Fonts & Iconos minimalistas (Lucide) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- part√≠culas fondo -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    :root {
      --bg-dark: #0b0c0f;
      --glass-bg: rgba(18, 22, 30, 0.7);
      --glass-border: rgba(80, 90, 120, 0.3);
      --card-bg: rgba(25, 30, 40, 0.7);
      --primary-glow: #00e0ff;
      --accent-tuta: #ffaa00;  /* color de Tuta */
      --accent-yop: #9f9fff;   /* color de Yop */
      --text-primary: #f0f3f8;
      --text-secondary: #aab3cc;
      --success: #2ee6a8;
      --shadow-heavy: 0 20px 40px -10px rgba(0,0,0,0.7);
      --blur-amount: 16px;
    }

    body.light {
      --bg-dark: #eef2f6;
      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-border: rgba(150, 160, 180, 0.3);
      --card-bg: rgba(255, 255, 255, 0.8);
      --text-primary: #121826;
      --text-secondary: #2f374b;
    }

    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      transition: background 0.3s ease;
      position: relative;
      backdrop-filter: blur(2px);
    }

    /* LOGIN */
    .login-screen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      background: var(--bg-dark);
      backdrop-filter: blur(20px);
    }
    .login-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 60px;
      padding: 3rem 2.5rem;
      width: 90%;
      max-width: 420px;
      box-shadow: var(--shadow-heavy);
      text-align: center;
      animation: floatIn 0.5s ease;
    }
    @keyframes floatIn {
      0% { opacity: 0; transform: scale(0.95) translateY(20px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }
    .login-card h2 {
      font-size: 2.4rem;
      font-weight: 700;
      background: linear-gradient(145deg, #ffaa00, #9f9fff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.2rem;
    }
    .login-sub {
      color: var(--text-secondary);
      margin-bottom: 2rem;
      font-size: 1.1rem;
    }
    .password-field {
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--glass-border);
      border-radius: 80px;
      padding: 16px 24px;
      width: 100%;
      color: var(--text-primary);
      font-size: 1.1rem;
      outline: none;
      margin-bottom: 1.8rem;
    }
    .login-btn {
      background: linear-gradient(145deg, #1f2a45, #0f172a);
      border: none;
      padding: 16px 32px;
      border-radius: 80px;
      font-weight: 700;
      font-size: 1.2rem;
      color: white;
      width: 100%;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 10px 0 #0b0f1c;
      transition: 0.1s ease;
    }
    .login-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 14px 0 #0b0f1c, 0 0 30px var(--primary-glow);
    }

    #app { display: none; }

    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0; left: 0;
      z-index: -1;
      pointer-events: none;
      opacity: 0.4;
    }

    /* LAYOUT PRINCIPAL */
    .glass-dashboard {
      max-width: 1400px;
      margin: 1.5rem;
      padding: 2rem;
      background: var(--glass-bg);
      backdrop-filter: blur(var(--blur-amount));
      border: 1px solid var(--glass-border);
      border-radius: 48px;
      box-shadow: var(--shadow-heavy);
    }

    /* HEADER con identidad Tuta & Yop */
    .app-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .logo-area {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .tuta-icon {
      background: rgba(255,170,0,0.15);
      border: 2px solid var(--accent-tuta);
      padding: 8px 16px;
      border-radius: 40px;
      font-weight: 700;
      color: var(--accent-tuta);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .yop-icon {
      background: rgba(159,159,255,0.15);
      border: 2px solid var(--accent-yop);
      padding: 8px 16px;
      border-radius: 40px;
      font-weight: 700;
      color: var(--accent-yop);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .logo-text h1 {
      font-weight: 700;
      font-size: 2rem;
      letter-spacing: -0.02em;
      background: linear-gradient(130deg, var(--accent-tuta), var(--accent-yop));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .badge {
      background: rgba(255,255,255,0.05);
      padding: 8px 18px;
      border-radius: 80px;
      border: 1px solid rgba(255,255,255,0.1);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    /* ESTAD√çSTICAS */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin: 30px 0;
    }
    .stat-card {
      background: var(--card-bg);
      backdrop-filter: blur(4px);
      border-radius: 32px;
      padding: 20px;
      border: 1px solid var(--glass-border);
    }
    .stat-title {
      font-size: 0.9rem;
      color: var(--text-secondary);
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 2.2rem;
      font-weight: 700;
    }
    .progress-micro {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      margin-top: 12px;
    }
    .progress-micro-fill {
      height: 6px;
      background: linear-gradient(90deg, var(--accent-tuta), var(--accent-yop));
      border-radius: 20px;
      width: 0%;
      transition: width 0.4s ease;
    }

    /* FILTROS Y B√öSQUEDA */
    .search-filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 25px;
    }
    .search-box {
      flex: 2;
      min-width: 240px;
      background: rgba(0,0,0,0.2);
      border-radius: 60px;
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      padding: 4px 4px 4px 20px;
    }
    .search-box input {
      background: transparent;
      border: none;
      padding: 12px;
      width: 100%;
      color: var(--text-primary);
      outline: none;
    }
    .filter-select {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
      border-radius: 60px;
      padding: 0 20px;
      color: var(--text-primary);
      font-weight: 500;
      outline: none;
    }

    /* INPUT TAREAS */
    .task-input-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      background: rgba(15,20,30,0.4);
      backdrop-filter: blur(10px);
      border-radius: 80px;
      padding: 12px 20px;
      margin-bottom: 30px;
      border: 1px solid var(--glass-border);
    }
    .task-input-panel input, .task-input-panel select {
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--glass-border);
      border-radius: 40px;
      padding: 12px 18px;
      color: var(--text-primary);
      flex: 1 1 150px;
      outline: none;
    }
    .task-input-panel button {
      background: linear-gradient(145deg, #1f2a45, #0f172a);
      border: none;
      padding: 12px 28px;
      border-radius: 40px;
      font-weight: 600;
      color: white;
      box-shadow: 0 6px 0 #0b0f1c;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* TAREAS */
    .tasks-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin: 20px 0;
    }
    .task-card {
      background: var(--card-bg);
      border-radius: 40px;
      padding: 16px 24px;
      border: 1px solid var(--glass-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      animation: taskAppear 0.3s ease;
    }
    .task-card.completed .task-title {
      text-decoration: line-through;
      opacity: 0.6;
    }
    .badge-materia {
      background: rgba(90,120,255,0.2);
      padding: 4px 12px;
      border-radius: 40px;
      border-left: 3px solid var(--primary-glow);
      font-size: 0.9rem;
    }
    .task-actions {
      display: flex;
      gap: 8px;
    }
    .icon-btn {
      background: transparent;
      border: 1px solid var(--glass-border);
      width: 40px;
      height: 40px;
      border-radius: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.15s;
    }
    .icon-btn:hover {
      background: var(--primary-glow);
      color: black;
    }

    /* ===== NUEVO: CHAT TUTA & YOP ===== */
    .chat-section {
      margin: 40px 0 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 48px;
      padding: 24px;
      border: 1px solid var(--glass-border);
    }
    .chat-title {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }
    .chat-title h3 {
      font-size: 1.5rem;
      font-weight: 600;
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 300px;
      overflow-y: auto;
      padding-right: 8px;
      margin-bottom: 20px;
    }
    .chat-message {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      animation: messageAppear 0.2s ease;
    }
    @keyframes messageAppear {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .message-tuta {
      flex-direction: row;
    }
    .message-yop {
      flex-direction: row-reverse;
    }
    .message-bubble {
      max-width: 70%;
      padding: 12px 18px;
      border-radius: 24px;
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
      position: relative;
    }
    .message-tuta .message-bubble {
      border-left: 4px solid var(--accent-tuta);
    }
    .message-yop .message-bubble {
      border-right: 4px solid var(--accent-yop);
    }
    .message-sender {
      font-weight: 700;
      font-size: 0.8rem;
      margin-bottom: 4px;
      color: var(--text-secondary);
    }
    .message-text {
      word-break: break-word;
    }
    .message-time {
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-top: 4px;
      text-align: right;
    }
    .chat-input-area {
      display: flex;
      gap: 12px;
      align-items: center;
      background: rgba(0,0,0,0.2);
      border-radius: 60px;
      padding: 8px 8px 8px 20px;
      border: 1px solid var(--glass-border);
    }
    .chat-input-area select {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
      border-radius: 40px;
      padding: 10px 16px;
      color: var(--text-primary);
      outline: none;
    }
    .chat-input-area input {
      flex: 1;
      background: transparent;
      border: none;
      padding: 12px;
      color: var(--text-primary);
      outline: none;
    }
    .chat-input-area button {
      background: linear-gradient(145deg, #1f2a45, #0f172a);
      border: none;
      padding: 12px 24px;
      border-radius: 40px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* ===== NUEVO: REPRODUCTOR DE M√öSICA ===== */
    .music-player-section {
      margin: 30px 0 20px;
      background: rgba(0,0,0,0.2);
      border-radius: 80px;
      padding: 16px 24px;
      border: 1px solid var(--glass-border);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
    }
    .music-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 2;
      min-width: 200px;
    }
    .music-controls {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .music-controls button {
      background: transparent;
      border: 1px solid var(--glass-border);
      width: 48px;
      height: 48px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-primary);
      transition: 0.15s;
    }
    .music-controls button:hover {
      background: var(--primary-glow);
      color: black;
    }
    .music-select {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
      border-radius: 40px;
      padding: 12px 20px;
      color: var(--text-primary);
      outline: none;
      min-width: 180px;
    }
    .volume-slider {
      width: 100px;
      height: 4px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      -webkit-appearance: none;
    }
    .volume-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: var(--primary-glow);
      border-radius: 50%;
      cursor: pointer;
    }

    .motivation-box {
      background: linear-gradient(110deg, #0c1f2e, #14253b);
      border-radius: 60px;
      padding: 18px 28px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 15px;
      border: 1px solid #2d4b6e;
    }

    .confetti-canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 9999;
    }
    #taskSound, #chatSound { display: none; }
  </style>
</head>
<body>
  <!-- LOGIN con contrase√±a Papucholangas -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h2>TUTA & BARRERA</h2>
      <div class="login-sub">d√∫o din√°mico ¬∑ acceso privado</div>
      <input type="password" id="passwordInput" class="password-field" placeholder="contrase√±a" autofocus>
      <button class="login-btn" id="loginBtn">ENTRAR AL ESTUDIO</button>
      <div style="margin-top: 20px; color: var(--text-secondary);">üîê Papucholangas</div>
    </div>
  </div>

  <!-- APLICACI√ìN PRINCIPAL -->
  <div id="app">
    <div id="particles-js"></div>
    <canvas id="confettiCanvas" class="confetti-canvas" style="display: none;"></canvas>
    <audio id="taskSound" src="data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gR2VtaW5pU291bmRzLnByb2Zlc3Npb25hbC5tcDMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQxAAAA18a4QaAQAADp8uFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"></audio>
    <audio id="chatSound" src="data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gR2VtaW5pU291bmRzLnByb2Zlc3Npb25hbC5tcDMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQxAAAA18a4QaAQAADp8uFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"></audio>

    <main class="glass-dashboard">
      <!-- HEADER PERSONALIZADO TUTA & YOP -->
      <div class="app-header">
        <div class="logo-area">
          <div class="tuta-icon"><i data-lucide="crown"></i> TUTA</div>
          <div class="yop-icon"><i data-lucide="sparkles"></i> BARRERA</div>
          <div class="logo-text"><h1>estudio en equipo</h1></div>
        </div>
        <div class="action-bar">
          <span class="badge"><i data-lucide="flame"></i> <span id="streakDisplay">0</span> racha</span>
          <span class="badge"><i data-lucide="zap"></i> nivel <span id="levelDisplay">1</span></span>
          <span class="badge"><i data-lucide="star"></i> <span id="pointsDisplay">0</span> pts</span>
          <div class="glass-button" id="themeToggle"><i data-lucide="moon"></i> tema</div>
        </div>
      </div>

      <!-- ESTAD√çSTICAS D√öO -->
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-title"><i data-lucide="check-circle"></i> completadas</div><div class="stat-value" id="completedCount">0</div><div class="progress-micro"><div class="progress-micro-fill" id="globalProgressBar"></div></div></div>
        <div class="stat-card"><div class="stat-title"><i data-lucide="list"></i> total tareas</div><div class="stat-value" id="totalTasks">0</div></div>
        <div class="stat-card"><div class="stat-title"><i data-lucide="layers"></i> materia activa</div><div class="stat-value" style="font-size:1.2rem;" id="subjectProgressText">‚ö° 0%</div><div class="progress-micro"><div class="progress-micro-fill" id="subjectProgressFill"></div></div></div>
        <div class="stat-card"><div class="stat-title"><i data-lucide="gift"></i> logro</div><div class="stat-value" style="font-size:1.2rem;" id="rewardBadge">üî∞ aprendices</div></div>
      </div>

      <!-- FILTROS -->
      <div class="search-filter-row">
        <div class="search-box"><i data-lucide="search"></i><input type="text" id="searchInput" placeholder="Buscar tarea..."></div>
        <select class="filter-select" id="filterSubject">
          <option value="*">Todas las materias</option>
          <option value="Matem√°ticas">üìê Mate con Tuta</option>
          <option value="F√≠sica">‚ö° F√≠sica con Yop</option>
          <option value="Castellano">üìñ Tuta escribe</option>
          <option value="Bioqu√≠mica">üß¨ Yop explica</option>
          <option value="Filosof√≠a">ü§î Tuta filosofa</option>
          <option value="Ingl√©s">üåé Yop traduce</option>
          <option value="Taller">üõ†Ô∏è Taller de Tuta</option>
          <option value="Baloncesto">üèÄ Baloncesto con Yop</option>
        </select>
      </div>

      <!-- INPUT TAREAS -->
      <div class="task-input-panel">
        <select id="materiaSelect">
          <option>Matem√°ticas</option><option>F√≠sica</option><option>Castellano</option><option>Bioqu√≠mica</option>
          <option>Filosof√≠a</option><option>Ingl√©s</option><option>Taller</option><option>Baloncesto</option>
        </select>
        <input type="text" id="taskInput" placeholder="Nombre de la tarea">
        <input type="date" id="dateInput">
        <button id="addTaskBtn"><i data-lucide="plus"></i> crear tarea</button>
      </div>

      <!-- MENSAJE MOTIVACIONAL CON PERSONALIDAD -->
      <div class="motivation-box" id="motivationMsg">
        <i data-lucide="message-circle"></i>
        <span>üß¢ Tuta dice: √âchale ganas, mi Yop.</span>
      </div>

      <!-- LISTA DE TAREAS -->
      <div id="tasksList" class="tasks-container"></div>

      <!-- ===== NUEVO: CHAT TUTA & YOP (EN VIVO) ===== -->
      <div class="chat-section">
        <div class="chat-title">
          <i data-lucide="message-square" width="28" style="color: var(--accent-tuta);"></i>
          <i data-lucide="message-square" width="28" style="color: var(--accent-yop);"></i>
          <h3>Chat del d√∫o ¬∑ tiempo real</h3>
        </div>
        <div id="chatContainer" class="chat-container">
          <!-- mensajes aparecen aqu√≠ -->
        </div>
        <div class="chat-input-area">
          <select id="chatSender">
            <option value="Tuta">üß¢ Tuta</option>
            <option value="Yop">üëì Yop</option>
          </select>
          <input type="text" id="chatInput" placeholder="Escribe un mensaje..." maxlength="200">
          <button id="sendChatBtn"><i data-lucide="send"></i> enviar</button>
        </div>
      </div>

      <!-- ===== NUEVO: REPRODUCTOR DE M√öSICA ===== -->
      <div class="music-player-section">
        <div class="music-info">
          <i data-lucide="music" style="color: var(--primary-glow);"></i>
          <span id="currentSong">üéµ Lo-fi para estudiar</span>
        </div>
        <div class="music-controls">
          <button id="playPauseBtn"><i data-lucide="play"></i></button>
          <button id="stopBtn"><i data-lucide="square"></i></button>
          <select id="musicSelect" class="music-select">
            <option value="https://cdn.pixabay.com/audio/2024/01/30/audio_5f1e3c2a6f.mp3">üéß Lo-fi beats</option>
            <option value="https://cdn.pixabay.com/audio/2023/07/10/audio_2a4b8c7d1e.mp3">üåßÔ∏è Jazz para concentrarse</option>
            <option value="https://cdn.pixabay.com/audio/2022/11/05/audio_9e8d7c6b5a.mp3">üìö Piano relajante</option>
            <option value="https://cdn.pixabay.com/audio/2021/09/01/audio_1a2b3c4d5e.mp3">üé∏ Tuta & Yop soundtrack</option>
          </select>
          <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.05" value="0.3">
        </div>
      </div>

      <div style="text-align: right; color: var(--text-secondary); margin-top: 15px;" id="virtualRewardLine">‚≠ê pr√≥ximo nivel: 100 pts</div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js';
    import { getDatabase, ref, push, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD8Z8M5TL-SU3oMFYULFaIzhBrD9yObXwo",
      authDomain: "papucholangas.firebaseapp.com",
      databaseURL: "https://papucholangas-default-rtdb.firebaseio.com",
      projectId: "papucholangas",
      storageBucket: "papucholangas.firebasestorage.app",
      messagingSenderId: "392558100266",
      appId: "1:392558100266:web:eb3a5313670bcafba96853"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tasksRef = ref(db, 'tareas');
    const chatRef = ref(db, 'chat');  // nueva referencia para chat

    // LOGIN
    const loginScreen = document.getElementById('loginScreen');
    const appContainer = document.getElementById('app');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');

    function checkPassword() {
      if (passwordInput.value === 'Papucholangas') {
        loginScreen.style.display = 'none';
        appContainer.style.display = 'block';
        initParticles();
        setupFirebaseListeners();
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;
      } else {
        alert('Contrase√±a incorrecta');
      }
    }
    loginBtn.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkPassword(); });

    // VARIABLES GLOBALES
    let allTasks = [];
    let userLevel = 1, userPoints = 0, streak = 0, lastCompletedDate = '';
    
    // Elementos DOM
    const tasksDiv = document.getElementById('tasksList');
    const totalSpan = document.getElementById('totalTasks');
    const completedSpan = document.getElementById('completedCount');
    const streakSpan = document.getElementById('streakDisplay');
    const levelSpan = document.getElementById('levelDisplay');
    const pointsSpan = document.getElementById('pointsDisplay');
    const globalBar = document.getElementById('globalProgressBar');
    const motMsg = document.getElementById('motivationMsg');
    const rewardLine = document.getElementById('virtualRewardLine');
    const subjectProgressText = document.getElementById('subjectProgressText');
    const subjectProgressFill = document.getElementById('subjectProgressFill');
    const searchInput = document.getElementById('searchInput');
    const filterSubject = document.getElementById('filterSubject');
    const addBtn = document.getElementById('addTaskBtn');
    const taskInput = document.getElementById('taskInput');
    const materiaSelect = document.getElementById('materiaSelect');
    const dateInput = document.getElementById('dateInput');
    const themeBtn = document.getElementById('themeToggle');
    
    // Chat elementos
    const chatContainer = document.getElementById('chatContainer');
    const chatSender = document.getElementById('chatSender');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    
    // M√∫sica elementos
    const audioPlayer = new Audio();
    audioPlayer.volume = 0.3;
    const playPauseBtn = document.getElementById('playPauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const musicSelect = document.getElementById('musicSelect');
    const volumeSlider = document.getElementById('volumeSlider');
    const currentSongSpan = document.getElementById('currentSong');
    
    // Confetti
    const confettiCanvas = document.getElementById('confettiCanvas');
    let confettiCtx = confettiCanvas.getContext('2d');
    let particles = [];
    const sound = document.getElementById('taskSound');
    const chatSound = document.getElementById('chatSound');

    // ========== FUNCIONES ==========
    function startConfetti() {
      confettiCanvas.style.display = 'block';
      for (let i=0; i<60; i++) particles.push({ x: Math.random()*window.innerWidth, y: -20, r: Math.random()*6+2, d: Math.random()*5+2, color: `hsl(${Math.random()*360},80%,60%)` });
      requestAnimationFrame(drawConfetti);
      setTimeout(() => { confettiCanvas.style.display = 'none'; particles = []; }, 2000);
    }
    function drawConfetti() {
      if (!confettiCanvas.style.display || confettiCanvas.style.display === 'none') return;
      confettiCtx.clearRect(0,0,window.innerWidth,window.innerHeight);
      particles.forEach(p => { p.y += p.d; if(p.y>window.innerHeight) p.y=-10; });
      particles.forEach(p => { confettiCtx.beginPath(); confettiCtx.arc(p.x, p.y, p.r, 0, Math.PI*2); confettiCtx.fillStyle = p.color; confettiCtx.fill(); });
      requestAnimationFrame(drawConfetti);
    }

    function updateStreak(tasks) {
      const today = new Date().toDateString().split(' ')[1]+' '+new Date().getDate();
      const completedToday = tasks.filter(t => t.hecho && t.completedDate === today).length;
      if (completedToday > 0) {
        if (lastCompletedDate !== today) { streak++; lastCompletedDate = today; }
      } else {
        const yesterday = new Date(Date.now()-864e5).toDateString().split(' ')[1]+' '+ (new Date(Date.now()-864e5).getDate());
        if (lastCompletedDate && lastCompletedDate !== today && lastCompletedDate !== yesterday) streak = 0;
      }
      streakSpan.innerText = streak;
    }

    function updateLevelAndPoints(completedDelta = 0) {
      if (completedDelta > 0) userPoints += 10 * completedDelta;
      let newLevel = Math.floor(userPoints / 100) + 1;
      if (newLevel > userLevel) {
        userLevel = newLevel;
        startConfetti();
        const levelMessages = ['aprendices', 'compas', 'dupla', 'leyendas', 'inmortales'];
        motMsg.innerHTML = `<i data-lucide="message-circle"></i><span>üéâ SUBIERON A NIVEL ${userLevel} ¬∑ ${levelMessages[Math.min(userLevel-1,4)]} üî•</span>`;
        lucide.createIcons();
      }
      levelSpan.innerText = userLevel;
      pointsSpan.innerText = userPoints;
    }

    // RENDER TAREAS
    function renderTasks(tasks) {
      allTasks = [...tasks];
      const searchTerm = searchInput.value.toLowerCase();
      const subjectFilter = filterSubject.value;
      let filtered = tasks.filter(t => t.texto.toLowerCase().includes(searchTerm));
      if (subjectFilter !== '*') filtered = filtered.filter(t => t.materia === subjectFilter);
      
      const total = filtered.length;
      const completed = filtered.filter(t => t.hecho).length;
      totalSpan.innerText = total;
      completedSpan.innerText = completed;
      const percent = total ? (completed/total)*100 : 0;
      globalBar.style.width = percent + '%';

      const subjectCounts = {};
      tasks.forEach(t => { if(!t.hecho) subjectCounts[t.materia] = (subjectCounts[t.materia]||0)+1; });
      const topSubject = Object.keys(subjectCounts).sort((a,b)=>subjectCounts[b]-subjectCounts[a])[0] || 'Ninguna';
      const totalSubj = tasks.filter(t=>t.materia===topSubject).length;
      const doneSubj = tasks.filter(t=>t.materia===topSubject && t.hecho).length;
      const subPercent = totalSubj? (doneSubj/totalSubj*100).toFixed(1):0;
      subjectProgressText.innerText = `${topSubject}: ${subPercent}%`;
      subjectProgressFill.style.width = subPercent + '%';

      // Mensajes con personalidad Tuta/Yop
      const tutaMsgs = ['üß¢ Tuta: √©chale ganas', 'üß¢ Tuta: ¬øya merito?', 'üß¢ Tuta: yo conf√≠o'];
      const yopMsgs = ['üëì Yop: vamos bien', 'üëì Yop: un paso m√°s', 'üëì Yop: t√∫ puedes'];
      const random = Math.floor(Math.random() * 3);
      motMsg.innerHTML = `<i data-lucide="message-circle"></i><span>${Math.random()>0.5 ? tutaMsgs[random] : yopMsgs[random]}</span>`;
      lucide.createIcons();

      const rewards = ['üî∞ aprendices', '‚ö° compas', 'üî• dupla', 'üíé leyendas', 'üèÜ inmortales'];
      rewardLine.innerText = `üéÅ ${rewards[Math.min(userLevel-1,4)]} ¬∑ pr√≥ximo en ${100 - (userPoints%100)}pts`;

      tasksDiv.innerHTML = filtered.map(t => {
        const dateStr = t.fecha ? new Date(t.fecha).toLocaleDateString() : 'sin fecha';
        return `<div class="task-card ${t.hecho ? 'completed' : ''}" data-key="${t.key}">
          <div class="task-info">
            <div class="task-title"><span class="badge-materia">${t.materia}</span> ${t.texto}</div>
            <div class="task-meta"><span><i data-lucide="calendar" width="14"></i> ${dateStr}</span></div>
          </div>
          <div class="task-actions">
            <button class="icon-btn complete-btn" data-key="${t.key}" data-done="${t.hecho}"><i data-lucide="${t.hecho ? 'rotate-ccw' : 'check'}"></i></button>
            <button class="icon-btn edit-btn" data-key="${t.key}" data-text="${t.texto}"><i data-lucide="pencil"></i></button>
            <button class="icon-btn delete-btn" data-key="${t.key}"><i data-lucide="trash-2"></i></button>
          </div>
        </div>`;
      }).join('');
      lucide.createIcons();

      document.querySelectorAll('.complete-btn').forEach(b => b.addEventListener('click', (e) => {
        const key = b.dataset.key; const done = b.dataset.done === 'true';
        update(ref(db, 'tareas/'+key), { hecho: !done });
        if (!done) {
          sound.play().catch(e=>{}); startConfetti();
          const today = new Date().toDateString().split(' ')[1]+' '+new Date().getDate();
          update(ref(db, 'tareas/'+key), { completedDate: today });
          updateLevelAndPoints(1);
        }
      }));
      document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', () => remove(ref(db, 'tareas/'+b.dataset.key))));
      document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', () => {
        const newText = prompt('Editar tarea:', b.dataset.text);
        if (newText) update(ref(db, 'tareas/'+b.dataset.key), { texto: newText });
      }));
    }

    // ===== FUNCIONES CHAT =====
    function renderChat(messages) {
      chatContainer.innerHTML = messages.reverse().map(msg => {
        const isTuta = msg.sender === 'Tuta';
        return `<div class="chat-message ${isTuta ? 'message-tuta' : 'message-yop'}">
          <div class="message-bubble">
            <div class="message-sender">${isTuta ? 'üß¢ Tuta' : 'üëì Yop'}</div>
            <div class="message-text">${msg.text}</div>
            <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</div>
          </div>
        </div>`;
      }).join('');
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ===== M√öSICA =====
    playPauseBtn.addEventListener('click', () => {
      if (audioPlayer.paused) {
        audioPlayer.play();
        playPauseBtn.innerHTML = '<i data-lucide="pause"></i>';
      } else {
        audioPlayer.pause();
        playPauseBtn.innerHTML = '<i data-lucide="play"></i>';
      }
      lucide.createIcons();
    });
    stopBtn.addEventListener('click', () => {
      audioPlayer.pause();
      audioPlayer.currentTime = 0;
      playPauseBtn.innerHTML = '<i data-lucide="play"></i>';
      lucide.createIcons();
    });
    musicSelect.addEventListener('change', () => {
      audioPlayer.src = musicSelect.value;
      audioPlayer.play();
      playPauseBtn.innerHTML = '<i data-lucide="pause"></i>';
      currentSongSpan.innerText = musicSelect.options[musicSelect.selectedIndex].text;
      lucide.createIcons();
    });
    volumeSlider.addEventListener('input', (e) => {
      audioPlayer.volume = e.target.value;
    });

    // ===== FIREBASE LISTENERS =====
    function setupFirebaseListeners() {
      onValue(tasksRef, (snapshot) => {
        const tasks = [];
        snapshot.forEach(child => tasks.push({ key: child.key, ...child.val() }));
        tasks.sort((a,b) => (a.fecha||'') > (b.fecha||'') ? 1 : -1);
        renderTasks(tasks);
        updateStreak(tasks);
      });

      onValue(chatRef, (snapshot) => {
        const msgs = [];
        snapshot.forEach(child => msgs.push({ key: child.key, ...child.val() }));
        msgs.sort((a,b) => b.timestamp - a.timestamp);
        renderChat(msgs);
        if (msgs.length > 0) chatSound.play().catch(e=>{});
      });
    }

    // ENVIAR MENSAJE CHAT
    sendChatBtn.addEventListener('click', () => {
      const text = chatInput.value.trim();
      if (!text) return;
      push(chatRef, {
        sender: chatSender.value,
        text: text,
        timestamp: Date.now()
      });
      chatInput.value = '';
    });
    chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatBtn.click(); });

    // AGREGAR TAREA
    addBtn.addEventListener('click', () => {
      const texto = taskInput.value.trim();
      if (!texto) return;
      push(tasksRef, {
        texto,
        materia: materiaSelect.value,
        fecha: dateInput.value || null,
        hecho: false
      });
      taskInput.value = '';
    });

    // TEMA CLARO/OSCURO
    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('light');
      const icon = themeBtn.querySelector('i');
      icon.setAttribute('data-lucide', document.body.classList.contains('light') ? 'sun' : 'moon');
      lucide.createIcons();
    });

    // FILTROS
    searchInput.addEventListener('input', () => renderTasks(allTasks));
    filterSubject.addEventListener('change', () => renderTasks(allTasks));

    window.addEventListener('resize', () => { confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; });

    function initParticles() {
      particlesJS('particles-js', {
        particles: { number: { value: 60 }, color: { value: '#4a80f0' }, opacity: { value: 0.3 }, size: { value: 2 }, line_linked: { enable: true, distance: 150, color: '#4a80f0', opacity: 0.2 }, move: { enable: true, speed: 0.8 } },
        interactivity: { detect_on: 'canvas', events: { onhover: { enable: true, mode: 'repulse' } } }
      });
    }

    // Precargar iconos
    lucide.createIcons();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>TUTA & BARRERA ¬∑ estudio definitivo</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- part√≠culas fondo -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    :root {
      --bg-dark: #0a0c12;
      --glass-bg: rgba(15, 20, 28, 0.85);
      --glass-border: rgba(70, 90, 140, 0.3);
      --card-bg: rgba(22, 28, 38, 0.8);
      --primary-glow: #00e0ff;
      --accent-tuta: #ffaa00;
      --accent-barrera: #ff5577;
      --text-primary: #f0f3f8;
      --text-secondary: #a5b3d1;
      --success: #2ee6a8;
      --danger: #ff5577;
      --shadow-heavy: 0 25px 45px -12px rgba(0,0,0,0.8);
      --blur-amount: 20px;
      --border-radius-main: 40px;
      --border-radius-card: 32px;
    }

    body.light {
      --bg-dark: #eef2f8;
      --glass-bg: rgba(255, 255, 255, 0.8);
      --glass-border: rgba(150, 170, 200, 0.4);
      --card-bg: rgba(255, 255, 255, 0.85);
      --text-primary: #121826;
      --text-secondary: #2f3a5a;
    }

    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      transition: background 0.3s ease;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0; left: 0;
      z-index: -1;
      pointer-events: none;
      opacity: 0.4;
    }

    /* LOGIN */
    .login-screen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      background: var(--bg-dark);
      backdrop-filter: blur(20px);
      padding: 16px;
    }
    .login-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 60px;
      padding: 2.5rem 2rem;
      width: 100%;
      max-width: 440px;
      box-shadow: var(--shadow-heavy);
      text-align: center;
      animation: floatI<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>TUTA & BARRERA ¬∑ estudio definitivo</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- part√≠culas fondo -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    :root {
      --bg-dark: #0a0c12;
      --glass-bg: rgba(15, 20, 28, 0.85);
      --glass-border: rgba(70, 90, 140, 0.3);
      --card-bg: rgba(22, 28, 38, 0.8);
      --primary-glow: #00e0ff;
      --accent-tuta: #ffaa00;
      --accent-barrera: #ff5577;
      --text-primary: #f0f3f8;
      --text-secondary: #a5b3d1;
      --success: #2ee6a8;
      --danger: #ff5577;
      --shadow-heavy: 0 25px 45px -12px rgba(0,0,0,0.8);
      --blur-amount: 20px;
      --border-radius-main: 40px;
      --border-radius-card: 32px;
    }

    body.light {
      --bg-dark: #eef2f8;
      --glass-bg: rgba(255, 255, 255, 0.8);
      --glass-border: rgba(150, 170, 200, 0.4);
      --card-bg: rgba(255, 255, 255, 0.85);
      --text-primary: #121826;
      --text-secondary: #2f3a5a;
    }

    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      transition: background 0.3s ease;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0; left: 0;
      z-index: -1;
      pointer-events: none;
      opacity: 0.4;
    }

    /* LOGIN */
    .login-screen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      background: var(--bg-dark);
      backdrop-filter: blur(20px);
      padding: 16px;
    }
    .login-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 60px;
      padding: 2.5rem 2rem;
      width: 100%;
      max-width: 440px;
      box-shadow: var(--shadow-heavy);
      text-align: center;
      animation: floatIn 0.5s ease;
    }
    @keyframes floatIn {
      0% { opacity: 0; transform: scale(0.95) translateY(20px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }
    .login-card h2 {
      font-size: 2.4rem;
      font-weight: 700;
      background: linear-gradient(145deg, #ffaa00, #ff5577);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }
    .login-sub {
      color: var(--text-secondary);
      margin-bottom: 2rem;
      font-size: 1rem;
    }
    .password-field {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
      border-radius: 60px;
      padding: 16px 24px;
      width: 100%;
      color: var(--text-primary);
      font-size: 1rem;
      outline: none;
      margin-bottom: 1.8rem;
    }
    .password-field:focus {
      border-color: var(--primary-glow);
      box-shadow: 0 0 0 3px rgba(0,224,255,0.2);
    }
    .login-btn {
      background: linear-gradient(145deg, #1f2a45, #0f172a);
      border: none;
      padding: 16px 32px;
      border-radius: 60px;
      font-weight: 700;
      font-size: 1.1rem;
      color: white;
      width: 100%;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 8px 0 #0b0f1c;
      transition: 0.1s ease;
    }
    .login-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 0 #0b0f1c, 0 0 25px var(--primary-glow);
    }

    #app {
      display: none;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* GLASS DASHBOARD PRINCIPAL */
    .glass-dashboard {
      width: 100%;
      padding: 1.5rem;
      background: var(--glass-bg);
      backdrop-filter: blur(var(--blur-amount));
      border: 1px solid var(--glass-border);
      border-radius: var(--border-radius-main);
      box-shadow: var(--shadow-heavy);
    }

    /* HEADER */
    .app-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      margin-bottom: 2rem;
    }
    .logo-area {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    .tuta-icon {
      background: rgba(255,170,0,0.15);
      border: 2px solid var(--accent-tuta);
      padding: 8px 16px;
      border-radius: 40px;
      font-weight: 700;
      color: var(--accent-tuta);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.95rem;
    }
    .barrera-icon {
      background: rgba(255,85,119,0.15);
      border: 2px solid var(--accent-barrera);
      padding: 8px 16px;
      border-radius: 40px;
      font-weight: 700;
      color: var(--accent-barrera);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.95rem;
    }
    .logo-text h1 {
      font-weight: 700;
      font-size: 1.8rem;
      letter-spacing: -0.02em;
      background: linear-gradient(130deg, var(--accent-tuta), var(--accent-barrera));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .action-bar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .badge {
      background: rgba(255,255,255,0.05);
      padding: 6px 14px;
      border-radius: 60px;
      border: 1px solid rgba(255,255,255,0.1);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }
    .glass-button {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(8px);
      padding: 8px 16px;
      border-radius: 60px;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }
    .glass-button:hover {
      background: rgba(120,160,255,0.2);
      border-color: var(--primary-glow);
    }

    /* STATS GRID - Responsive */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 14px;
      margin: 30px 0;
    }
    .stat-card {
      background: var(--card-bg);
      backdrop-filter: blur(4px);
      border-radius: var(--border-radius-card);
      padding: 18px 16px;
      border: 1px solid var(--glass-border);
      transition: 0.2s;
    }
    .stat-card:hover {
      border-color: var(--primary-glow);
      transform: translateY(-3px);
    }
    .stat-title {
      font-size: 0.85rem;
      color: var(--text-secondary);
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
    }
    .progress-micro {
      height: 5px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      margin-top: 12px;
    }
    .progress-micro-fill {
      height: 5px;
      background: linear-gradient(90deg, var(--accent-tuta), var(--accent-barrera));
      border-radius: 10px;
      width: 0%;
      transition: width 0.4s ease;
    }

    /* B√öSQUEDA Y FILTROS - ACTUALIZADO con nuevas materias */
    .search-filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .search-box {
      flex: 2;
      min-width: 200px;
      background: rgba(0,0,0,0.2);
      border-radius: 60px;
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      padding: 4px 4px 4px 16px;
    }
    .search-box input {
      background: transparent;
      border: none;
      padding: 10px 8px;
      width: 100%;
      color: var(--text-primary);
      outline: none;
      font-size: 0.95rem;
    }
    .filter-select {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
      border-radius: 60px;
      padding: 0 16px;
      color: var(--text-primary);
      font-weight: 500;
      outline: none;
      font-size: 0.95rem;
      min-width: 160px;
    }

    /* INPUT TAREAS - ACTUALIZADO con nuevas materias */
    .task-input-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      background: rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      border-radius: 60px;
      padding: 12px 16px;
      margin-bottom: 30px;
      border: 1px solid var(--glass-border);
    }
    .task-input-panel input,
    .task-input-panel select {
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--glass-border);
      border-radius: 40px;
      padding: 10px 14px;
      color: var(--text-primary);
      flex: 1 1 130px;
      outline: none;
      font-size: 0.9rem;
    }
    .task-input-panel button {
      background: linear-gradient(145deg, #1f2a45, #0f172a);
      border: none;
      padding: 10px 20px;
      border-radius: 40px;
      font-weight: 600;
      color: white;
      box-shadow: 0 5px 0 #0b0f1c;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    /* TAREAS - con colores para nuevas materias */
    .tasks-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 20px 0;
    }
    .task-card {
      background: var(--card-bg);
      border-radius: 30px;
      padding: 14px 18px;
      border: 1px solid var(--glass-border);
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      animation: taskAppear 0.3s ease;
    }
    @keyframes taskAppear {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .task-card.completed .task-title {
      text-decoration: line-through;
      opacity: 0.6;
    }
    .task-info {
      flex: 2;
      min-width: 200px;
    }
    .task-title {
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .badge-materia {
      background: rgba(90,120,255,0.2);
      padding: 4px 10px;
      border-radius: 30px;
      border-left: 3px solid var(--primary-glow);
      font-size: 0.8rem;
    }
    /* Colores espec√≠ficos para materias */
    .badge-materia[data-materia="Matem√°ticas"] { border-left-color: #00ff88; }
    .badge-materia[data-materia="F√≠sica"] { border-left-color: #00c3ff; }
    .badge-materia[data-materia="Castellano"] { border-left-color: #ff4d4d; }
    .badge-materia[data-materia="Bioqu√≠mica"] { border-left-color: #a64dff; }
    .badge-materia[data-materia="Filosof√≠a"] { border-left-color: #ffcc00; }
    .badge-materia[data-materia="Ingl√©s"] { border-left-color: #ff99cc; }
    .badge-materia[data-materia="Taller"] { border-left-color: #00ffcc; }
    .badge-materia[data-materia="Baloncesto"] { border-left-color: #ff9900; }
    .badge-materia[data-materia="√âtica"] { border-left-color: #66cc66; }
    .badge-materia[data-materia="Dibujo"] { border-left-color: #ff66b2; }
    .badge-materia[data-materia="Sociales"] { border-left-color: #ff9933; }
    .badge-materia[data-materia="Religi√≥n"] { border-left-color: #cc66ff; }
    .badge-materia[data-materia="Artes"] { border-left-color: #ff6666; }
    .badge-materia[data-materia="Inform√°tica"] { border-left-color: #66ccff; }
    
    .task-meta {
      display: flex;
      gap: 15px;
      color: var(--text-secondary);
      font-size: 0.75rem;
      margin-top: 5px;
    }
    .task-actions {
      display: flex;
      gap: 6px;
    }
    .icon-btn {
      background: transparent;
      border: 1px solid var(--glass-border);
      width: 36px;
      height: 36px;
      border-radius: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.15s;
    }
    .icon-btn:hover {
      background: var(--primary-glow);
      color: black;
    }

    /* CHAT SECTION */
    .chat-section {
      margin: 40px 0 25px;
      background: rgba(0,0,0,0.2);
      border-radius: 40px;
      padding: 20px;
      border: 1px solid var(--glass-border);
    }
    .chat-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .chat-title h3 {
      font-size: 1.3rem;
      font-weight: 600;
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 250px;
      overflow-y: auto;
      padding-right: 8px;
      margin-bottom: 20px;
    }
    .chat-message {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      animation: messageAppear 0.2s ease;
    }
    @keyframes messageAppear {
      from { opacity: 0; transform: translateX(-5px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .message-tuta {
      flex-direction: row;
    }
    .message-barrera {
      flex-direction: row-reverse;
    }
    .message-bubble {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 20px;
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
    }
    .message-tuta .message-bubble {
      border-left: 4px solid var(--accent-tuta);
    }
    .message-barrera .message-bubble {
      border-right: 4px solid var(--accent-barrera);
    }
    .message-sender {
      font-weight: 700;
      font-size: 0.75rem;
      margin-bottom: 4px;
      color: var(--text-secondary);
    }
    .message-text {
      word-break: break-word;
      font-size: 0.9rem;
    }
    .message-time {
      font-size: 0.65rem;
      color: var(--text-secondary);
      margin-top: 4px;
      text-align: right;
    }

    /* REACCIONES */
    .reacciones-container {
      display: flex;
      gap: 6px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .emoji-reaccion {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--glass-border);
      border-radius: 30px;
      padding: 4px 10px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      transition: 0.15s;
    }
    .emoji-reaccion:hover {
      background: rgba(255,255,255,0.15);
      transform: scale(1.05);
    }

    .chat-input-area {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      background: rgba(0,0,0,0.2);
      border-radius: 60px;
      padding: 8px 8px 8px 16px;
      border: 1px solid var(--glass-border);
    }
    .chat-input-area select {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
      border-radius: 40px;
      padding: 8px 12px;
      color: var(--text-primary);
      outline: none;
      font-size: 0.9rem;
    }
    .chat-input-area input {
      flex: 2;
      min-width: 150px;
      background: transparent;
      border: none;
      padding: 10px 8px;
      color: var(--text-primary);
      outline: none;
      font-size: 0.9rem;
    }
    .chat-input-area button {
      background: linear-gradient(145deg, #1f2a45, #0f172a);
      border: none;
      padding: 10px 18px;
      border-radius: 40px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    /* COMPETENCIA */
    .competencia-section {
      background: var(--card-bg);
      border-radius: 40px;
      padding: 22px;
      margin: 30px 0;
      border: 1px solid var(--glass-border);
    }
    .competencia-titulo {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 25px;
    }
    .competencia-titulo h3 {
      font-size: 1.3rem;
    }
    .competencia-barras {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .barra-competencia {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .barra-nombre {
      width: 80px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .barra-contenedor {
      flex: 1;
      height: 36px;
      background: rgba(255,255,255,0.1);
      border-radius: 36px;
      overflow: hidden;
      display: flex;
      position: relative;
    }
    .barra-tuta {
      height: 100%;
      background: var(--accent-tuta);
      width: 0%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 10px;
      color: #000;
      font-weight: 700;
      font-size: 0.9rem;
    }
    .barra-barrera {
      height: 100%;
      background: var(--accent-barrera);
      width: 0%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      padding-left: 10px;
      color: #000;
      font-weight: 700;
      font-size: 0.9rem;
    }
    .barra-vs {
      width: 50px;
      text-align: center;
      font-weight: 700;
      color: var(--primary-glow);
    }

    /* MODO NO MOLESTAR */
    .dnd-section {
      background: var(--card-bg);
      border-radius: 40px;
      padding: 22px;
      margin: 30px 0;
      border: 1px solid var(--glass-border);
    }
    .dnd-estado {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 15px;
    }
    .dnd-indicador {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    .dnd-badge {
      padding: 8px 16px;
      border-radius: 40px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
    }
    .dnd-badge.disponible {
      background: rgba(46, 230, 168, 0.2);
      border: 1px solid var(--success);
      color: var(--success);
    }
    .dnd-badge.nodisponible {
      background: rgba(255, 85, 119, 0.2);
      border: 1px solid var(--danger);
      color: var(--danger);
    }
    .dnd-toggle {
      display: flex;
      gap: 10px;
    }

    /* LOGROS */
    .logros-section {
      background: var(--card-bg);
      border-radius: 40px;
      padding: 22px;
      margin: 30px 0;
      border: 1px solid var(--glass-border);
    }
    .logros-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }
    .logro-card {
      background: rgba(0,0,0,0.2);
      border-radius: 30px;
      padding: 16px 12px;
      text-align: center;
      border: 1px solid var(--glass-border);
      transition: 0.2s;
      opacity: 0.5;
      filter: grayscale(0.8);
    }
    .logro-card.bloqueado {
      opacity: 0.3;
      filter: grayscale(1);
    }
    .logro-card.completado {
      opacity: 1;
      filter: grayscale(0);
      border-color: var(--primary-glow);
      box-shadow: 0 0 20px rgba(0,224,255,0.2);
    }
    .logro-icon {
      font-size: 2.2rem;
      margin-bottom: 8px;
    }
    .logro-nombre {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    .logro-desc {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }

    /* RESUMEN SEMANAL */
    .resumen-section {
      background: linear-gradient(145deg, #0f1a28, #1a2538);
      border-radius: 40px;
      padding: 22px;
      margin: 30px 0;
      border: 1px solid var(--primary-glow);
    }
    .resumen-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .resumen-stat {
      text-align: center;
    }
    .resumen-numero {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-glow);
    }
    .resumen-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* EX√ÅMENES - ACTUALIZADO con nuevas materias */
    .examen-section {
      background: var(--card-bg);
      border-radius: 40px;
      padding: 22px;
      margin: 30px 0;
      border: 1px solid var(--glass-border);
    }
    .examen-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .examen-input-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 40px;
      padding: 15px;
      margin-bottom: 25px;
      border: 1px solid var(--glass-border);
    }
    .examen-input-panel input,
    .examen-input-panel select {
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--glass-border);
      border-radius: 30px;
      padding: 10px 14px;
      color: var(--text-primary);
      flex: 1 1 130px;
      outline: none;
    }
    .examen-input-panel button {
      background: linear-gradient(145deg, #1f2a45, #0f172a);
      border: none;
      padding: 10px 20px;
      border-radius: 30px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .examen-item {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      margin-top: 15px;
      padding: 15px;
      background: rgba(0,0,0,0.2);
      border-radius: 30px;
      border: 1px solid var(--glass-border);
    }
    .examen-info {
      flex: 2;
      min-width: 200px;
    }
    .examen-materia {
      font-weight: 700;
      font-size: 1.1rem;
    }
    .examen-fecha {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    .examen-progress {
      flex: 1;
      min-width: 150px;
    }
    progress {
      width: 100%;
      height: 10px;
      border-radius: 20px;
      overflow: hidden;
    }
    progress::-webkit-progress-bar {
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
    }
    progress::-webkit-progress-value {
      background: linear-gradient(90deg, var(--accent-tuta), var(--accent-barrera));
      border-radius: 20px;
    }
    .examen-actions {
      display: flex;
      gap: 6px;
    }

    /* BOT√ìN BLEND */
    .blend-section {
      margin: 30px 0 20px;
      text-align: center;
    }
    .barrera-blend-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      background: linear-gradient(145deg, #ff5577, #b13e55);
      padding: 16px 28px;
      border-radius: 60px;
      color: white;
      text-decoration: none;
      font-weight: 700;
      font-size: 1rem;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 8px 0 #6b2533, 0 10px 25px rgba(255,85,119,0.3);
      transition: all 0.2s ease;
      width: 100%;
      max-width: 480px;
    }
    .barrera-blend-button:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 0 #6b2533, 0 15px 30px rgba(255,85,119,0.5);
      background: linear-gradient(145deg, #ff6688, #c2455a);
    }

    .motivation-box {
      background: linear-gradient(110deg, #0f1a28, #1a2538);
      border-radius: 50px;
      padding: 16px 22px;
      margin: 25px 0 15px;
      display: flex;
      align-items: center;
      gap: 12px;
      border: 1px solid #2d4b6e;
      font-size: 1rem;
    }

    .confetti-canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    /* Responsive */
    @media (max-width: 600px) {
      body { padding: 8px; }
      .glass-dashboard { padding: 1rem; }
      .logo-text h1 { font-size: 1.4rem; }
      .tuta-icon, .barrera-icon { font-size: 0.8rem; padding: 5px 10px; }
      .badge { font-size: 0.8rem; padding: 4px 10px; }
      .stat-value { font-size: 1.6rem; }
      .task-card { padding: 12px; }
      .task-title { font-size: 0.95rem; }
      .barrera-blend-button { padding: 14px 20px; font-size: 0.9rem; }
    }

    #taskSound, #chatSound { display: none; }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h2>TUTA & BARRERA</h2>
      <div class="login-sub">estudio en equipo ¬∑ acceso privado</div>
      <input type="password" id="passwordInput" class="password-field" placeholder="Contrase√±a" autofocus>
      <button class="login-btn" id="loginBtn">ENTRAR AL ESTUDIO</button>
    </div>
  </div>

  <!-- APLICACI√ìN PRINCIPAL -->
  <div id="app">
    <div id="particles-js"></div>
    <canvas id="confettiCanvas" class="confetti-canvas" style="display: none;"></canvas>
    <audio id="taskSound" src="data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gR2VtaW5pU291bmRzLnByb2Zlc3Npb25hbC5tcDMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQxAAAA18a4QaAQAADp8uFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"></audio>
    <audio id="chatSound" src="data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gR2VtaW5pU291bmRzLnByb2Zlc3Npb25hbC5tcDMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQxAAAA18a4QaAQAADp8uFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"></audio>

    <main class="glass-dashboard">
      <!-- HEADER -->
      <div class="app-header">
        <div class="logo-area">
          <div class="tuta-icon"><i data-lucide="crown"></i> TUTA</div>
          <div class="barrera-icon"><i data-lucide="zap"></i> BARRERA</div>
          <div class="logo-text"><h1>estudio en equipo</h1></div>
        </div>
        <div class="action-bar">
          <span class="badge"><i data-lucide="flame"></i> <span id="streakDisplay">0</span> racha</span>
          <span class="badge"><i data-lucide="zap"></i> nivel <span id="levelDisplay">1</span></span>
          <span class="badge"><i data-lucide="star"></i> <span id="pointsDisplay">0</span> pts</span>
          <div class="glass-button" id="themeToggle"><i data-lucide="moon"></i> tema</div>
        </div>
      </div>

      <!-- ESTAD√çSTICAS B√ÅSICAS -->
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-title"><i data-lucide="check-circle"></i> completadas</div><div class="stat-value" id="completedCount">0</div><div class="progress-micro"><div class="progress-micro-fill" id="globalProgressBar"></div></div></div>
        <div class="stat-card"><div class="stat-title"><i data-lucide="list"></i> total tareas</div><div class="stat-value" id="totalTasks">0</div></div>
        <div class="stat-card"><div class="stat-title"><i data-lucide="layers"></i> materia activa</div><div class="stat-value" style="font-size:1.2rem;" id="subjectProgressText">‚ö° 0%</div><div class="progress-micro"><div class="progress-micro-fill" id="subjectProgressFill"></div></div></div>
        <div class="stat-card"><div class="stat-title"><i data-lucide="gift"></i> logro</div><div class="stat-value" style="font-size:1.2rem;" id="rewardBadge">üî∞ aprendices</div></div>
      </div>

      <!-- FILTROS - ACTUALIZADO con nuevas materias -->
      <div class="search-filter-row">
        <div class="search-box"><i data-lucide="search"></i><input type="text" id="searchInput" placeholder="Buscar tarea..."></div>
        <select class="filter-select" id="filterSubject">
          <option value="*">Todas las materias</option>
          <option value="Matem√°ticas">üìê Mate con Tuta</option>
          <option value="F√≠sica">‚ö° F√≠sica con Barrera</option>
          <option value="Castellano">üìñ Tuta escribe</option>
          <option value="Bioqu√≠mica">üß¨ Barrera explica</option>
          <option value="Filosof√≠a">ü§î Tuta filosofa</option>
          <option value="Ingl√©s">üåé Barrera traduce</option>
          <option value="Taller">üõ†Ô∏è Taller de Tuta</option>
          <option value="Baloncesto">üèÄ Baloncesto con Barrera</option>
          <option value="√âtica">‚öñÔ∏è √âtica con Tuta</option>
          <option value="Dibujo">üé® Dibujo con Barrera</option>
          <option value="Sociales">üåç Sociales con Tuta</option>
          <option value="Religi√≥n">‚õ™ Religi√≥n con Barrera</option>
          <option value="Artes">üé≠ Artes con Tuta</option>
          <option value="Inform√°tica">üíª Inform√°tica con Barrera</option>
        </select>
      </div>

      <!-- INPUT TAREAS - ACTUALIZADO con nuevas materias -->
      <div class="task-input-panel">
        <select id="materiaSelect">
          <option>Matem√°ticas</option><option>F√≠sica</option><option>Castellano</option><option>Bioqu√≠mica</option>
          <option>Filosof√≠a</option><option>Ingl√©s</option><option>Taller</option><option>Baloncesto</option>
          <option>√âtica</option><option>Dibujo</option><option>Sociales</option><option>Religi√≥n</option>
          <option>Artes</option><option>Inform√°tica</option>
        </select>
        <input type="text" id="taskInput" placeholder="Nombre de la tarea">
        <input type="date" id="dateInput">
        <button id="addTaskBtn"><i data-lucide="plus"></i> crear</button>
      </div>

      <!-- MENSAJE MOTIVACIONAL -->
      <div class="motivation-box" id="motivationMsg">
        <i data-lucide="message-circle"></i>
        <span>üß¢ Tuta dice: √âchale ganas, mi Barrera.</span>
      </div>

      <!-- LISTA DE TAREAS -->
      <div id="tasksList" class="tasks-container"></div>

      <!-- COMPETENCIA -->
      <div class="competencia-section">
        <div class="competencia-titulo">
          <i data-lucide="trophy" width="28" height="28" style="color: var(--accent-tuta);"></i>
          <i data-lucide="swords" width="24" height="24" style="color: var(--accent-barrera);"></i>
          <h3>Competencia del d√≠a</h3>
        </div>
        <div class="competencia-barras">
          <div class="barra-competencia">
            <span class="barra-nombre"><i data-lucide="crown" width="16"></i> Tuta</span>
            <div class="barra-contenedor">
              <div class="barra-tuta" id="barraTuta" style="width: 0%;">0</div>
            </div>
            <span class="barra-vs">VS</span>
          </div>
          <div class="barra-competencia">
            <span class="barra-nombre"><i data-lucide="zap" width="16"></i> Barrera</span>
            <div class="barra-contenedor">
              <div class="barra-barrera" id="barraBarrera" style="width: 0%;">0</div>
            </div>
          </div>
        </div>
        <div style="text-align: center; margin-top: 15px; color: var(--text-secondary);" id="competenciaMensaje">
          üèÜ ¬°El que gane hoy, elige la pr√≥xima playlist!
        </div>
      </div>

      <!-- CHAT -->
      <div class="chat-section">
        <div class="chat-title">
          <i data-lucide="message-square" width="24" style="color: var(--accent-tuta);"></i>
          <i data-lucide="message-square" width="24" style="color: var(--accent-barrera);"></i>
          <h3>Chat del d√∫o ¬∑ tiempo real</h3>
        </div>
        <div id="chatContainer" class="chat-container">
          <!-- mensajes din√°micos -->
        </div>
        <div class="chat-input-area">
          <select id="chatSender">
            <option value="Tuta">üß¢ Tuta</option>
            <option value="Barrera">‚ö° Barrera</option>
          </select>
          <input type="text" id="chatInput" placeholder="Escribe un mensaje..." maxlength="200">
          <button id="sendChatBtn"><i data-lucide="send"></i> enviar</button>
        </div>
        <!-- Barra de emojis -->
        <div class="reacciones-container" id="reaccionesRapidas">
          <span class="emoji-reaccion" data-emoji="üî•">üî• 0</span>
          <span class="emoji-reaccion" data-emoji="üëç">üëç 0</span>
          <span class="emoji-reaccion" data-emoji="üéâ">üéâ 0</span>
          <span class="emoji-reaccion" data-emoji="ü§£">ü§£ 0</span>
          <span class="emoji-reaccion" data-emoji="üíØ">üíØ 0</span>
        </div>
      </div>

      <!-- MODO NO MOLESTAR -->
      <div class="dnd-section">
        <div class="dnd-estado">
          <div class="dnd-indicador">
            <i data-lucide="bell" width="24" height="24"></i>
            <span style="font-weight: 600;">Estado de enfoque:</span>
            <div class="dnd-badge disponible" id="dndTuta">
              <i data-lucide="crown" width="16"></i> Tuta: <span>Disponible</span>
            </div>
            <div class="dnd-badge disponible" id="dndBarrera">
              <i data-lucide="zap" width="16"></i> Barrera: <span>Disponible</span>
            </div>
          </div>
          <div class="dnd-toggle">
            <button class="glass-button" id="toggleDndTuta"><i data-lucide="bell-off"></i> No molestar</button>
            <button class="glass-button" id="toggleDndBarrera"><i data-lucide="bell-off"></i> No molestar</button>
          </div>
        </div>
      </div>

      <!-- LOGROS -->
      <div class="logros-section">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
          <i data-lucide="award" width="28" height="28" style="color: var(--primary-glow);"></i>
          <h3>Logros desbloqueados</h3>
        </div>
        <div class="logros-grid" id="logrosContainer">
          <!-- Se generan con JS -->
        </div>
      </div>

      <!-- RESUMEN SEMANAL -->
      <div class="resumen-section">
        <div style="display: flex; align-items: center; gap: 10px;">
          <i data-lucide="calendar-check" width="28" height="28" style="color: var(--success);"></i>
          <h3>Resumen de la semana</h3>
        </div>
        <div class="resumen-stats" id="resumenSemanal">
          <div class="resumen-stat">
            <div class="resumen-numero" id="resumenTareas">0</div>
            <div class="resumen-label">tareas</div>
          </div>
          <div class="resumen-stat">
            <div class="resumen-numero" id="resumenRacha">0</div>
            <div class="resumen-label">racha m√°xima</div>
          </div>
          <div class="resumen-stat">
            <div class="resumen-numero" id="resumenMensajes">0</div>
            <div class="resumen-label">mensajes</div>
          </div>
          <div class="resumen-stat">
            <div class="resumen-numero" id="resumenPuntos">0</div>
            <div class="resumen-label">puntos</div>
          </div>
        </div>
        <div style="text-align: center; color: var(--primary-glow); margin-top: 10px; font-size: 0.9rem;">
          üéµ Canci√≥n m√°s escuchada: "Blend de Barrera"
        </div>
      </div>

      <!-- EX√ÅMENES - ACTUALIZADO con nuevas materias -->
      <div class="examen-section">
        <div class="examen-header">
          <i data-lucide="calendar-clock" width="28" height="28" style="color: var(--accent-tuta);"></i>
          <h3>Pr√≥ximos ex√°menes</h3>
        </div>
        
        <!-- Panel para agregar examen -->
        <div class="examen-input-panel">
          <select id="examenMateria">
            <option>Matem√°ticas</option><option>F√≠sica</option><option>Castellano</option><option>Bioqu√≠mica</option>
            <option>Filosof√≠a</option><option>Ingl√©s</option><option>Taller</option><option>Baloncesto</option>
            <option>√âtica</option><option>Dibujo</option><option>Sociales</option><option>Religi√≥n</option>
            <option>Artes</option><option>Inform√°tica</option>
          </select>
          <input type="date" id="examenFecha" placeholder="Fecha">
          <input type="number" id="examenProgreso" min="0" max="100" value="50" placeholder="% preparado">
          <button id="addExamenBtn"><i data-lucide="plus"></i> Agregar examen</button>
        </div>
        
        <!-- Lista de ex√°menes -->
        <div id="examenesContainer">
          <!-- Los ex√°menes se generan aqu√≠ -->
        </div>
      </div>

      <!-- BOT√ìN BLEND -->
      <div class="blend-section">
        <a href="https://open.spotify.com/blend/taste-match/b926f9f31b37b705?si=I5sMqomiTrKrn2LSQ9nqMg&fallback=getapp&blendDecoration=5f9c38d2" 
           target="_blank" 
           class="barrera-blend-button">
          <i data-lucide="headphones" width="22" height="22"></i>
          <span>üé∂ ABRIR BLEND DE BARRERA EN SPOTIFY</span>
          <i data-lucide="external-link" width="18" height="18"></i>
        </a>
        <div style="text-align: center; color: var(--text-secondary); font-size: 0.8rem; margin-top: 10px; opacity: 0.8;">
          <i data-lucide="heart" width="14" height="14" style="display: inline; margin-right: 4px;"></i> 
          Blend de Tuta & Barrera
        </div>
      </div>

      <!-- RECOMPENSA VIRTUAL -->
      <div style="text-align: right; color: var(--text-secondary); margin-top: 15px; font-size:0.9rem;" id="virtualRewardLine">‚≠ê pr√≥ximo nivel: 100 pts</div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js';
    import { getDatabase, ref, push, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD8Z8M5TL-SU3oMFYULFaIzhBrD9yObXwo",
      authDomain: "papucholangas.firebaseapp.com",
      databaseURL: "https://papucholangas-default-rtdb.firebaseio.com",
      projectId: "papucholangas",
      storageBucket: "papucholangas.firebasestorage.app",
      messagingSenderId: "392558100266",
      appId: "1:392558100266:web:eb3a5313670bcafba96853"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tasksRef = ref(db, 'tareas');
    const chatRef = ref(db, 'chat');
    const examenesRef = ref(db, 'examenes');
    const dndRef = ref(db, 'modoNoMolestar');

    // LOGIN
    const loginScreen = document.getElementById('loginScreen');
    const appContainer = document.getElementById('app');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');

    function checkPassword() {
      if (passwordInput.value === 'Papucholangas') {
        loginScreen.style.display = 'none';
        appContainer.style.display = 'block';
        initParticles();
        setupFirebaseListeners();
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;
        initLogros();
        actualizarCompetencia();
      } else {
        alert('Contrase√±a incorrecta');
      }
    }
    loginBtn.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkPassword(); });

    // VARIABLES GLOBALES
    let allTasks = [];
    let userLevel = 1, userPoints = 0, streak = 0, lastCompletedDate = '';
    let tareasTuta = 0, tareasBarrera = 0;
    let logros = [
      { id: 1, nombre: 'Primeros pasos', desc: 'Completar 5 tareas', icon: 'üå±', completado: false },
      { id: 2, nombre: 'Dupla imparable', desc: '10 tareas en equipo', icon: 'ü§ù', completado: false },
      { id: 3, nombre: 'Racha 7 d√≠as', desc: 'Una semana seguida', icon: 'üî•', completado: false },
      { id: 4, nombre: 'Chat activo', desc: '50 mensajes', icon: 'üí¨', completado: false },
      { id: 5, nombre: 'Maestro', desc: '8 materias diferentes', icon: 'üìö', completado: false },
      { id: 6, nombre: 'Modo diablo', desc: '20 tareas en un d√≠a', icon: 'üòà', completado: false }
    ];
    
    // Elementos DOM
    const tasksDiv = document.getElementById('tasksList');
    const totalSpan = document.getElementById('totalTasks');
    const completedSpan = document.getElementById('completedCount');
    const streakSpan = document.getElementById('streakDisplay');
    const levelSpan = document.getElementById('levelDisplay');
    const pointsSpan = document.getElementById('pointsDisplay');
    const globalBar = document.getElementById('globalProgressBar');
    const motMsg = document.getElementById('motivationMsg');
    const rewardLine = document.getElementById('virtualRewardLine');
    const subjectProgressText = document.getElementById('subjectProgressText');
    const subjectProgressFill = document.getElementById('subjectProgressFill');
    const searchInput = document.getElementById('searchInput');
    const filterSubject = document.getElementById('filterSubject');
    const addBtn = document.getElementById('addTaskBtn');
    const taskInput = document.getElementById('taskInput');
    const materiaSelect = document.getElementById('materiaSelect');
    const dateInput = document.getElementById('dateInput');
    const themeBtn = document.getElementById('themeToggle');
    
    // Chat
    const chatContainer = document.getElementById('chatContainer');
    const chatSender = document.getElementById('chatSender');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    
    // Competencia
    const barraTuta = document.getElementById('barraTuta');
    const barraBarrera = document.getElementById('barraBarrera');
    const competenciaMensaje = document.getElementById('competenciaMensaje');
    
    // Logros
    const logrosContainer = document.getElementById('logrosContainer');
    
    // Resumen
    const resumenTareas = document.getElementById('resumenTareas');
    const resumenRacha = document.getElementById('resumenRacha');
    const resumenMensajes = document.getElementById('resumenMensajes');
    const resumenPuntos = document.getElementById('resumenPuntos');
    
    // DND
    const dndTuta = document.getElementById('dndTuta');
    const dndBarrera = document.getElementById('dndBarrera');
    const toggleDndTuta = document.getElementById('toggleDndTuta');
    const toggleDndBarrera = document.getElementById('toggleDndBarrera');
    
    // Ex√°menes
    const examenesContainer = document.getElementById('examenesContainer');
    const examenMateria = document.getElementById('examenMateria');
    const examenFecha = document.getElementById('examenFecha');
    const examenProgreso = document.getElementById('examenProgreso');
    const addExamenBtn = document.getElementById('addExamenBtn');
    
    // Confetti
    const confettiCanvas = document.getElementById('confettiCanvas');
    let confettiCtx = confettiCanvas.getContext('2d');
    let particles = [];
    const sound = document.getElementById('taskSound');
    const chatSound = document.getElementById('chatSound');

    // ===== FUNCIONES =====
    function startConfetti() {
      confettiCanvas.style.display = 'block';
      for (let i=0; i<60; i++) particles.push({ x: Math.random()*window.innerWidth, y: -20, r: Math.random()*6+2, d: Math.random()*5+2, color: `hsl(${Math.random()*360},80%,60%)` });
      requestAnimationFrame(drawConfetti);
      setTimeout(() => { confettiCanvas.style.display = 'none'; particles = []; }, 2000);
    }
    
    function drawConfetti() {
      if (!confettiCanvas.style.display || confettiCanvas.style.display === 'none') return;
      confettiCtx.clearRect(0,0,window.innerWidth,window.innerHeight);
      particles.forEach(p => { p.y += p.d; if(p.y>window.innerHeight) p.y=-10; });
      particles.forEach(p => { confettiCtx.beginPath(); confettiCtx.arc(p.x, p.y, p.r, 0, Math.PI*2); confettiCtx.fillStyle = p.color; confettiCtx.fill(); });
      requestAnimationFrame(drawConfetti);
    }

    function updateStreak(tasks) {
      const today = new Date().toDateString().split(' ')[1]+' '+new Date().getDate();
      const completedToday = tasks.filter(t => t.hecho && t.completedDate === today).length;
      if (completedToday > 0) {
        if (lastCompletedDate !== today) { streak++; lastCompletedDate = today; }
      } else {
        const yesterday = new Date(Date.now()-864e5).toDateString().split(' ')[1]+' '+ (new Date(Date.now()-864e5).getDate());
        if (lastCompletedDate && lastCompletedDate !== today && lastCompletedDate !== yesterday) streak = 0;
      }
      streakSpan.innerText = streak;
      return streak;
    }

    function updateLevelAndPoints(completedDelta = 0, autor = 'desconocido') {
      if (completedDelta > 0) {
        userPoints += 10 * completedDelta;
        if (autor === 'Tuta') tareasTuta += completedDelta;
        if (autor === 'Barrera') tareasBarrera += completedDelta;
      }
      let newLevel = Math.floor(userPoints / 100) + 1;
      if (newLevel > userLevel) {
        userLevel = newLevel;
        startConfetti();
        const levelMessages = ['aprendices', 'compas', 'dupla', 'leyendas', 'inmortales'];
        motMsg.innerHTML = `<i data-lucide="message-circle"></i><span>üéâ SUBIERON A NIVEL ${userLevel} ¬∑ ${levelMessages[Math.min(userLevel-1,4)]} üî•</span>`;
        lucide.createIcons();
      }
      levelSpan.innerText = userLevel;
      pointsSpan.innerText = userPoints;
      
      actualizarCompetencia();
      resumenPuntos.innerText = userPoints;
    }

    function actualizarCompetencia() {
      const total = tareasTuta + tareasBarrera;
      if (total > 0) {
        const porcentajeTuta = (tareasTuta / total) * 100;
        const porcentajeBarrera = (tareasBarrera / total) * 100;
        barraTuta.style.width = porcentajeTuta + '%';
        barraBarrera.style.width = porcentajeBarrera + '%';
        barraTuta.innerHTML = tareasTuta;
        barraBarrera.innerHTML = tareasBarrera;
        
        if (tareasTuta > tareasBarrera) {
          competenciaMensaje.innerHTML = 'üèÜ Tuta va ganando!';
        } else if (tareasBarrera > tareasTuta) {
          competenciaMensaje.innerHTML = 'üèÜ Barrera va ganando!';
        } else {
          competenciaMensaje.innerHTML = '‚öîÔ∏è Est√°n empatados!';
        }
      }
    }

    // RENDER TAREAS
    function renderTasks(tasks) {
      allTasks = [...tasks];
      const searchTerm = searchInput.value.toLowerCase();
      const subjectFilter = filterSubject.value;
      let filtered = tasks.filter(t => t.texto.toLowerCase().includes(searchTerm));
      if (subjectFilter !== '*') filtered = filtered.filter(t => t.materia === subjectFilter);
      
      const total = filtered.length;
      const completed = filtered.filter(t => t.hecho).length;
      totalSpan.innerText = total;
      completedSpan.innerText = completed;
      const percent = total ? (completed/total)*100 : 0;
      globalBar.style.width = percent + '%';

      const subjectCounts = {};
      tasks.forEach(t => { if(!t.hecho) subjectCounts[t.materia] = (subjectCounts[t.materia]||0)+1; });
      const topSubject = Object.keys(subjectCounts).sort((a,b)=>subjectCounts[b]-subjectCounts[a])[0] || 'Ninguna';
      const totalSubj = tasks.filter(t=>t.materia===topSubject).length;
      const doneSubj = tasks.filter(t=>t.materia===topSubject && t.hecho).length;
      const subPercent = totalSubj? (doneSubj/totalSubj*100).toFixed(1):0;
      subjectProgressText.innerText = `${topSubject}: ${subPercent}%`;
      subjectProgressFill.style.width = subPercent + '%';

      // Mensajes
      const tutaMsgs = ['üß¢ Tuta: √©chale ganas', 'üß¢ Tuta: ¬øya merito?', 'üß¢ Tuta: yo conf√≠o en ti'];
      const barreraMsgs = ['‚ö° Barrera: vamos bien', '‚ö° Barrera: un paso m√°s', '‚ö° Barrera: t√∫ puedes'];
      const random = Math.floor(Math.random() * 3);
      motMsg.innerHTML = `<i data-lucide="message-circle"></i><span>${Math.random()>0.5 ? tutaMsgs[random] : barreraMsgs[random]}</span>`;
      lucide.createIcons();

      const rewards = ['üî∞ aprendices', '‚ö° compas', 'üî• dupla', 'üíé leyendas', 'üèÜ inmortales'];
      rewardLine.innerText = `üéÅ ${rewards[Math.min(userLevel-1,4)]} ¬∑ pr√≥ximo en ${100 - (userPoints%100)}pts`;

      tasksDiv.innerHTML = filtered.map(t => {
        const dateStr = t.fecha ? new Date(t.fecha).toLocaleDateString() : 'sin fecha';
        return `<div class="task-card ${t.hecho ? 'completed' : ''}" data-key="${t.key}">
          <div class="task-info">
            <div class="task-title">
              <span class="badge-materia" data-materia="${t.materia}">${t.materia}</span> 
              ${t.texto}
            </div>
            <div class="task-meta"><span><i data-lucide="calendar" width="12"></i> ${dateStr}</span></div>
          </div>
          <div class="task-actions">
            <button class="icon-btn complete-btn" data-key="${t.key}" data-done="${t.hecho}"><i data-lucide="${t.hecho ? 'rotate-ccw' : 'check'}"></i></button>
            <button class="icon-btn edit-btn" data-key="${t.key}" data-text="${t.texto}"><i data-lucide="pencil"></i></button>
            <button class="icon-btn delete-btn" data-key="${t.key}"><i data-lucide="trash-2"></i></button>
          </div>
        </div>`;
      }).join('');
      lucide.createIcons();

      // Eventos
      document.querySelectorAll('.complete-btn').forEach(b => b.addEventListener('click', (e) => {
        e.stopPropagation();
        const key = b.dataset.key; const done = b.dataset.done === 'true';
        update(ref(db, 'tareas/'+key), { hecho: !done });
        if (!done) {
          sound.play().catch(e=>{}); startConfetti();
          const today = new Date().toDateString().split(' ')[1]+' '+new Date().getDate();
          update(ref(db, 'tareas/'+key), { completedDate: today });
          
          const autor = Math.random() > 0.5 ? 'Tuta' : 'Barrera';
          updateLevelAndPoints(1, autor);
          verificarLogros();
        }
      }));
      
      document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', (e) => {
        e.stopPropagation();
        remove(ref(db, 'tareas/'+b.dataset.key));
      }));
      
      document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', (e) => {
        e.stopPropagation();
        const newText = prompt('Editar tarea:', b.dataset.text);
        if (newText && newText.trim()) update(ref(db, 'tareas/'+b.dataset.key), { texto: newText.trim() });
      }));
      
      const completadasSemana = tasks.filter(t => {
        if (!t.completedDate) return false;
        const fecha = new Date(t.completedDate);
        const hoy = new Date();
        const diff = hoy - fecha;
        return diff <= 7 * 24 * 60 * 60 * 1000;
      }).length;
      resumenTareas.innerText = completadasSemana;
    }

    // ===== FUNCIONES CHAT CON REACCIONES CORREGIDAS =====
    function renderChat(messages) {
      const sorted = [...messages].sort((a, b) => a.timestamp - b.timestamp);
      chatContainer.innerHTML = sorted.map(msg => {
        const isTuta = msg.sender === 'Tuta';
        const reacciones = msg.reacciones || {};
        const emojis = ['üî•', 'üëç', 'üéâ', 'ü§£', 'üíØ'];
        
        const reaccionesHtml = emojis.map(emoji => {
          const count = reacciones[emoji] || 0;
          return `<span class="emoji-reaccion" data-message-id="${msg.key}" data-emoji="${emoji}">${emoji} ${count}</span>`;
        }).join('');
        
        return `<div class="chat-message ${isTuta ? 'message-tuta' : 'message-barrera'}">
          <div class="message-bubble">
            <div class="message-sender">${isTuta ? 'üß¢ Tuta' : '‚ö° Barrera'}</div>
            <div class="message-text">${msg.text}</div>
            <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
            <div class="reacciones-container">
              ${reaccionesHtml}
            </div>
          </div>
        </div>`;
      }).join('');
      
      chatContainer.scrollTop = chatContainer.scrollHeight;
      
      // Agregar listeners de UNA SOLA VEZ
      document.querySelectorAll('.emoji-reaccion').forEach(emojiSpan => {
        emojiSpan.removeEventListener('click', manejarClickReaccion);
        emojiSpan.addEventListener('click', manejarClickReaccion);
      });
      
      resumenMensajes.innerText = messages.length;
    }

    function manejarClickReaccion(event) {
      const span = event.currentTarget;
      const messageId = span.dataset.messageId;
      const emoji = span.dataset.emoji;
      
      if (!messageId || !emoji) return;
      
      event.stopPropagation();
      
      const reaccionRef = ref(db, `chat/${messageId}/reacciones/${emoji}`);
      
      // onlyOnce: true es la clave para leer UNA sola vez
      onValue(reaccionRef, (snapshot) => {
        const current = snapshot.val() || 0;
        update(ref(db, `chat/${messageId}/reacciones`), { [emoji]: current + 1 });
      }, { onlyOnce: true });
    }

    // ENVIAR MENSAJE CHAT
    sendChatBtn.addEventListener('click', () => {
      const text = chatInput.value.trim();
      if (!text) return;
      
      push(chatRef, {
        sender: chatSender.value,
        text: text,
        timestamp: Date.now(),
        reacciones: {}
      }).then(() => {
        chatInput.value = '';
      });
    });

    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendChatBtn.click();
      }
    });

    // ===== MODO NO MOLESTAR =====
    let dndEstado = { Tuta: false, Barrera: false };
    
    toggleDndTuta.addEventListener('click', () => {
      dndEstado.Tuta = !dndEstado.Tuta;
      update(ref(db, 'modoNoMolestar'), dndEstado);
    });
    
    toggleDndBarrera.addEventListener('click', () => {
      dndEstado.Barrera = !dndEstado.Barrera;
      update(ref(db, 'modoNoMolestar'), dndEstado);
    });
    
    function actualizarDND(estado) {
      dndEstado = estado;
      
      if (estado.Tuta) {
        dndTuta.classList.remove('disponible');
        dndTuta.classList.add('nodisponible');
        dndTuta.querySelector('span').innerText = 'No molestar';
        toggleDndTuta.innerHTML = '<i data-lucide="bell"></i> Disponible';
      } else {
        dndTuta.classList.remove('nodisponible');
        dndTuta.classList.add('disponible');
        dndTuta.querySelector('span').innerText = 'Disponible';
        toggleDndTuta.innerHTML = '<i data-lucide="bell-off"></i> No molestar';
      }
      
      if (estado.Barrera) {
        dndBarrera.classList.remove('disponible');
        dndBarrera.classList.add('nodisponible');
        dndBarrera.querySelector('span').innerText = 'No molestar';
        toggleDndBarrera.innerHTML = '<i data-lucide="bell"></i> Disponible';
      } else {
        dndBarrera.classList.remove('nodisponible');
        dndBarrera.classList.add('disponible');
        dndBarrera.querySelector('span').innerText = 'Disponible';
        toggleDndBarrera.innerHTML = '<i data-lucide="bell-off"></i> No molestar';
      }
      lucide.createIcons();
    }

    // ===== LOGROS =====
    function initLogros() {
      logrosContainer.innerHTML = logros.map(logro => `
        <div class="logro-card ${logro.completado ? 'completado' : 'bloqueado'}" id="logro-${logro.id}">
          <div class="logro-icon">${logro.icon}</div>
          <div class="logro-nombre">${logro.nombre}</div>
          <div class="logro-desc">${logro.desc}</div>
        </div>
      `).join('');
    }
    
    function verificarLogros() {
      if (userPoints >= 50) logros[0].completado = true;
      if (tareasTuta + tareasBarrera >= 10) logros[1].completado = true;
      if (streak >= 7) logros[2].completado = true;
      if (parseInt(resumenMensajes.innerText) >= 50) logros[3].completado = true;
      
      const materiasHechas = new Set(allTasks.filter(t => t.hecho).map(t => t.materia));
      if (materiasHechas.size >= 8) logros[4].completado = true;
      
      const tareasHoy = allTasks.filter(t => {
        if (!t.fecha) return false;
        const fechaTarea = new Date(t.fecha).toDateString();
        const hoy = new Date().toDateString();
        return fechaTarea === hoy && t.hecho;
      }).length;
      if (tareasHoy >= 20) logros[5].completado = true;
      
      logros.forEach(logro => {
        const el = document.getElementById(`logro-${logro.id}`);
        if (el) {
          if (logro.completado) {
            el.classList.remove('bloqueado');
            el.classList.add('completado');
          }
        }
      });
    }

    // ===== EX√ÅMENES =====
    function renderExamenes(examenes) {
      examenesContainer.innerHTML = '';
      if (!examenes || examenes.length === 0) {
        examenesContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No hay ex√°menes agregados a√∫n</div>';
        return;
      }
      
      const sorted = [...examenes].sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
      
      sorted.forEach(examen => {
        const examenDiv = document.createElement('div');
        examenDiv.className = 'examen-item';
        examenDiv.innerHTML = `
          <div class="examen-info">
            <div class="examen-materia">üìö ${examen.materia}</div>
            <div class="examen-fecha">üìÖ ${new Date(examen.fecha).toLocaleDateString()}</div>
          </div>
          <div class="examen-progress">
            <progress value="${examen.progreso}" max="100"></progress>
            <div style="font-size: 0.8rem; text-align: right;">${examen.progreso}% preparado</div>
          </div>
          <div class="examen-actions">
            <button class="icon-btn delete-examen" data-key="${examen.key}"><i data-lucide="trash-2"></i></button>
          </div>
        `;
        examenesContainer.appendChild(examenDiv);
        
        examenDiv.querySelector('.delete-examen').addEventListener('click', () => {
          remove(ref(db, 'examenes/' + examen.key));
        });
      });
      lucide.createIcons();
    }

    addExamenBtn.addEventListener('click', () => {
      const materia = examenMateria.value;
      const fecha = examenFecha.value;
      const progreso = examenProgreso.value;
      
      if (!fecha) {
        alert('Por favor selecciona una fecha');
        return;
      }
      
      push(examenesRef, {
        materia,
        fecha,
        progreso: parseInt(progreso)
      });
      
      examenFecha.value = '';
      examenProgreso.value = '50';
    });

    // ===== FIREBASE LISTENERS =====
    function setupFirebaseListeners() {
      onValue(tasksRef, (snapshot) => {
        const tasks = [];
        snapshot.forEach(child => tasks.push({ key: child.key, ...child.val() }));
        tasks.sort((a,b) => (a.fecha||'') > (b.fecha||'') ? 1 : -1);
        renderTasks(tasks);
        const streakActual = updateStreak(tasks);
        resumenRacha.innerText = streakActual;
      });

      onValue(chatRef, (snapshot) => {
        const msgs = [];
        snapshot.forEach(child => {
          msgs.push({ 
            key: child.key, 
            ...child.val() 
          });
        });
        renderChat(msgs);
        if (msgs.length > 0) {
          chatSound.play().catch(e => console.log("Sound error:", e));
        }
      });
      
      onValue(dndRef, (snapshot) => {
        const estado = snapshot.val() || { Tuta: false, Barrera: false };
        actualizarDND(estado);
      });
      
      onValue(examenesRef, (snapshot) => {
        const examenes = [];
        snapshot.forEach(child => {
          examenes.push({ key: child.key, ...child.val() });
        });
        renderExamenes(examenes);
      });
    }

    // AGREGAR TAREA
    addBtn.addEventListener('click', () => {
      const texto = taskInput.value.trim();
      if (!texto) return;
      push(tasksRef, {
        texto,
        materia: materiaSelect.value,
        fecha: dateInput.value || null,
        hecho: false
      });
      taskInput.value = '';
    });

    // TEMA CLARO/OSCURO
    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('light');
      const icon = themeBtn.querySelector('i');
      if (document.body.classList.contains('light')) {
        icon.setAttribute('data-lucide', 'sun');
      } else {
        icon.setAttribute('data-lucide', 'moon');
      }
      lucide.createIcons();
    });

    // FILTROS
    searchInput.addEventListener('input', () => renderTasks(allTasks));
    filterSubject.addEventListener('change', () => renderTasks(allTasks));

    window.addEventListener('resize', () => { 
      confettiCanvas.width = window.innerWidth; 
      confettiCanvas.height = window.innerHeight; 
    });

    function initParticles() {
      particlesJS('particles-js', {
        particles: { 
          number: { value: 50 }, 
          color: { value: '#4a80f0' }, 
          opacity: { value: 0.25 }, 
          size: { value: 2.5 }, 
          line_linked: { enable: true, distance: 150, color: '#4a80f0', opacity: 0.15 }, 
          move: { enable: true, speed: 0.6 } 
        },
        interactivity: { 
          detect_on: 'canvas', 
          events: { onhover: { enable: true, mode: 'repulse' } } 
        }
      });
    }

    lucide.createIcons();
  </script>
</body>
</html>


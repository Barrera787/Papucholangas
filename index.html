<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>TUTA & BARRERA ¬∑ estudio en equipo</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <!-- part√≠culas fondo -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <!-- Spotify SDK -->
  <script src="https://open.spotify.com/embed/iframe-api/v1"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    :root {
      --bg-dark: #0a0c12;
      --glass-bg: rgba(15, 20, 28, 0.85);
      --glass-border: rgba(70, 90, 140, 0.3);
      --card-bg: rgba(22, 28, 38, 0.8);
      --primary-glow: #00e0ff;
      --accent-tuta: #ffaa00;
      --accent-barrera: #ff5577;
      --text-primary: #f0f3f8;
      --text-secondary: #a5b3d1;
      --success: #2ee6a8;
      --shadow-heavy: 0 25px 45px -12px rgba(0,0,0,0.8);
      --blur-amount: 20px;
      --border-radius-main: 40px;
      --border-radius-card: 32px;
    }

    body.light {
      --bg-dark: #eef2f8;
      --glass-bg: rgba(255, 255, 255, 0.8);
      --glass-border: rgba(150, 170, 200, 0.4);
      --card-bg: rgba(255, 255, 255, 0.85);
      --text-primary: #121826;
      --text-secondary: #2f3a5a;
    }

    body {
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      transition: background 0.3s ease;
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
    }

    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0; left: 0;
      z-index: -1;
      pointer-events: none;
      opacity: 0.4;
    }

    /* LOGIN */
    .login-screen {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      display: flex;
 align-items: center;
      justify-content: center;
      z-index: 10000;
      background: var(--bg-dark);
      backdrop-filter: blur(20px);
      padding: 16px;
    }
    .login-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 60px;
      padding: 2.5rem 2rem;
      width: 100%;
      max-width: 440px;
      box-shadow: var(--shadow-heavy);
      text-align: center;
      animation: floatIn 0.5s ease;
    }
    @keyframes floatIn {
      0% { opacity: 0; transform: scale(0.95) translateY(20px); }
      100% { opacity: 1; transform: scale(1) translateY(0); }
    }
    .login-card h2 {
      font-size: 2.4rem;
      font-weight: 700;
      background: linear-gradient(145deg, #ffaa00, #ff5577);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }
    .login-sub {
      color: var(--text-secondary);
      margin-bottom: 2rem;
      font-size: 1rem;
    }
    .password-field {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
      border-radius: 60px;
      padding: 16px 24px;
      width: 100%;
      color: var(--text-primary);
      font-size: 1rem;
      outline: none;
      margin-bottom: 1.8rem;
    }
    .password-field:focus {
      border-color: var(--primary-glow);
      box-shadow: 0 0 0 3px rgba(0,224,255,0.2);
    }
    .login-btn {
      background: linear-gradient(145deg, #1f2a45, #0f172a);
      border: none;
      padding: 16px 32px;
      border-radius: 60px;
      font-weight: 700;
      font-size: 1.1rem;
      color: white;
      width: 100%;
      cursor: pointer;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 8px 0 #0b0f1c;
      transition: 0.1s ease;
    }
    .login-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 0 #0b0f1c, 0 0 25px var(--primary-glow);
    }
    .login-btn:active {
      transform: translateY(5px);
      box-shadow: 0 5px 0 #0b0f1c;
    }

    #app {
      display: none;
      width: 100%;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* GLASS DASHBOARD PRINCIPAL */
    .glass-dashboard {
      width: 100%;
      padding: 1.5rem;
      background: var(--glass-bg);
      backdrop-filter: blur(var(--blur-amount));
      border: 1px solid var(--glass-border);
      border-radius: var(--border-radius-main);
      box-shadow: var(--shadow-heavy);
    }

    /* HEADER */
    .app-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
      margin-bottom: 2rem;
    }
    .logo-area {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    .tuta-icon {
      background: rgba(255,170,0,0.15);
      border: 2px solid var(--accent-tuta);
      padding: 8px 16px;
      border-radius: 40px;
      font-weight: 700;
      color: var(--accent-tuta);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.95rem;
    }
    .barrera-icon {
      background: rgba(255,85,119,0.15);
      border: 2px solid var(--accent-barrera);
      padding: 8px 16px;
      border-radius: 40px;
      font-weight: 700;
      color: var(--accent-barrera);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.95rem;
    }
    .logo-text h1 {
      font-weight: 700;
      font-size: 1.8rem;
      letter-spacing: -0.02em;
      background: linear-gradient(130deg, var(--accent-tuta), var(--accent-barrera));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .action-bar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .badge {
      background: rgba(255,255,255,0.05);
      padding: 6px 14px;
      border-radius: 60px;
      border: 1px solid rgba(255,255,255,0.1);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }
    .glass-button {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(8px);
      padding: 8px 16px;
      border-radius: 60px;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }
    .glass-button:hover {
      background: rgba(120,160,255,0.2);
      border-color: var(--primary-glow);
    }

    /* STATS GRID - Responsive */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 14px;
      margin: 30px 0;
    }
    .stat-card {
      background: var(--card-bg);
      backdrop-filter: blur(4px);
      border-radius: var(--border-radius-card);
      padding: 18px 16px;
      border: 1px solid var(--glass-border);
      transition: 0.2s;
    }
    .stat-card:hover {
      border-color: var(--primary-glow);
      transform: translateY(-3px);
    }
    .stat-title {
      font-size: 0.85rem;
      color: var(--text-secondary);
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
    }
    .progress-micro {
      height: 5px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      margin-top: 12px;
    }
    .progress-micro-fill {
      height: 5px;
      background: linear-gradient(90deg, var(--accent-tuta), var(--accent-barrera));
      border-radius: 10px;
      width: 0%;
      transition: width 0.4s ease;
    }

    /* B√öSQUEDA Y FILTROS */
    .search-filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }
    .search-box {
      flex: 2;
      min-width: 200px;
      background: rgba(0,0,0,0.2);
      border-radius: 60px;
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      padding: 4px 4px 4px 16px;
    }
    .search-box input {
      background: transparent;
      border: none;
      padding: 10px 8px;
      width: 100%;
      color: var(--text-primary);
      outline: none;
      font-size: 0.95rem;
    }
    .filter-select {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
      border-radius: 60px;
      padding: 0 16px;
      color: var(--text-primary);
      font-weight: 500;
      outline: none;
      font-size: 0.95rem;
      min-width: 160px;
    }

    /* INPUT TAREAS - Responsive */
    .task-input-panel {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      background: rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      border-radius: 60px;
      padding: 12px 16px;
      margin-bottom: 30px;
      border: 1px solid var(--glass-border);
    }
    .task-input-panel input,
    .task-input-panel select {
      background: rgba(0,0,0,0.25);
      border: 1px solid var(--glass-border);
      border-radius: 40px;
      padding: 10px 14px;
      color: var(--text-primary);
      flex: 1 1 130px;
      outline: none;
      font-size: 0.9rem;
    }
    .task-input-panel button {
      background: linear-gradient(145deg, #1f2a45, #0f172a);
      border: none;
      padding: 10px 20px;
      border-radius: 40px;
      font-weight: 600;
      color: white;
      box-shadow: 0 5px 0 #0b0f1c;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    /* TAREAS */
    .tasks-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 20px 0;
    }
    .task-card {
      background: var(--card-bg);
      border-radius: 30px;
      padding: 14px 18px;
      border: 1px solid var(--glass-border);
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      animation: taskAppear 0.3s ease;
    }
    @keyframes taskAppear {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .task-card.completed .task-title {
      text-decoration: line-through;
      opacity: 0.6;
    }
    .task-info {
      flex: 2;
      min-width: 200px;
    }
    .task-title {
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .badge-materia {
      background: rgba(90,120,255,0.2);
      padding: 4px 10px;
      border-radius: 30px;
      border-left: 3px solid var(--primary-glow);
      font-size: 0.8rem;
    }
    .task-meta {
      display: flex;
      gap: 15px;
      color: var(--text-secondary);
      font-size: 0.75rem;
      margin-top: 5px;
    }
    .task-actions {
      display: flex;
      gap: 6px;
    }
    .icon-btn {
      background: transparent;
      border: 1px solid var(--glass-border);
      width: 36px;
      height: 36px;
      border-radius: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: 0.15s;
    }
    .icon-btn:hover {
      background: var(--primary-glow);
      color: black;
    }

    /* CHAT SECTION */
    .chat-section {
      margin: 40px 0 25px;
      background: rgba(0,0,0,0.2);
      border-radius: 40px;
      padding: 20px;
      border: 1px solid var(--glass-border);
    }
    .chat-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .chat-title h3 {
      font-size: 1.3rem;
      font-weight: 600;
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 250px;
      overflow-y: auto;
      padding-right: 8px;
      margin-bottom: 20px;
    }
    .chat-message {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      animation: messageAppear 0.2s ease;
    }
    @keyframes messageAppear {
      from { opacity: 0; transform: translateX(-5px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .message-tuta {
      flex-direction: row;
    }
    .message-barrera {
      flex-direction: row-reverse;
    }
    .message-bubble {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 20px;
      background: var(--card-bg);
      border: 1px solid var(--glass-border);
    }
    .message-tuta .message-bubble {
      border-left: 4px solid var(--accent-tuta);
    }
    .message-barrera .message-bubble {
      border-right: 4px solid var(--accent-barrera);
    }
    .message-sender {
      font-weight: 700;
      font-size: 0.75rem;
      margin-bottom: 4px;
      color: var(--text-secondary);
    }
    .message-text {
      word-break: break-word;
      font-size: 0.9rem;
    }
    .message-time {
      font-size: 0.65rem;
      color: var(--text-secondary);
      margin-top: 4px;
      text-align: right;
    }
    .chat-input-area {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      background: rgba(0,0,0,0.2);
      border-radius: 60px;
      padding: 8px 8px 8px 16px;
      border: 1px solid var(--glass-border);
    }
    .chat-input-area select {
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
      border-radius: 40px;
      padding: 8px 12px;
      color: var(--text-primary);
      outline: none;
      font-size: 0.9rem;
    }
    .chat-input-area input {
      flex: 2;
      min-width: 150px;
      background: transparent;
      border: none;
      padding: 10px 8px;
      color: var(--text-primary);
      outline: none;
      font-size: 0.9rem;
    }
    .chat-input-area button {
      background: linear-gradient(145deg, #1f2a45, #0f172a);
      border: none;
      padding: 10px 18px;
      border-radius: 40px;
      font-weight: 600;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      white-space: nowrap;
    }

    /* SPOTIFY PLAYER */
    .spotify-player {
      margin: 30px 0 20px;
      border-radius: 30px;
      overflow: hidden;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--glass-border);
    }
    .spotify-embed {
      width: 100%;
      height: 352px;
      border: none;
      border-radius: 30px;
    }

    .motivation-box {
      background: linear-gradient(110deg, #0f1a28, #1a2538);
      border-radius: 50px;
      padding: 16px 22px;
      margin: 25px 0 15px;
      display: flex;
      align-items: center;
      gap: 12px;
      border: 1px solid #2d4b6e;
      font-size: 1rem;
    }

    .confetti-canvas {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      pointer-events: none;
      z-index: 9999;
    }

    /* Responsive extra */
    @media (max-width: 600px) {
      body { padding: 8px; }
      .glass-dashboard { padding: 1rem; }
      .logo-text h1 { font-size: 1.4rem; }
      .tuta-icon, .barrera-icon { font-size: 0.8rem; padding: 5px 10px; }
      .badge { font-size: 0.8rem; padding: 4px 10px; }
      .stat-value { font-size: 1.6rem; }
      .task-card { padding: 12px; }
      .task-title { font-size: 0.95rem; }
      .chat-input-area select, .chat-input-area input, .chat-input-area button { font-size: 0.85rem; }
    }

    /* Ocultar elementos de audio nativos */
    #taskSound, #chatSound { display: none; }
  </style>
</head>
<body>
  <!-- LOGIN con contrase√±a Papucholangas -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h2>TUTA & BARRERA</h2>
      <div class="login-sub">estudio en equipo ¬∑ acceso privado</div>
      <input type="password" id="passwordInput" class="password-field" placeholder="Contrase√±a" autofocus>
      <button class="login-btn" id="loginBtn">ENTRAR AL ESTUDIO</button>
      <!-- Texto eliminado como solicitaste -->
    </div>
  </div>

  <!-- APLICACI√ìN PRINCIPAL -->
  <div id="app">
    <div id="particles-js"></div>
    <canvas id="confettiCanvas" class="confetti-canvas" style="display: none;"></canvas>
    <audio id="taskSound" src="data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gR2VtaW5pU291bmRzLnByb2Zlc3Npb25hbC5tcDMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQxAAAA18a4QaAQAADp8uFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"></audio>
    <audio id="chatSound" src="data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gR2VtaW5pU291bmRzLnByb2Zlc3Npb25hbC5tcDMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA//uQxAAAA18a4QaAQAADp8uFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"></audio>

    <main class="glass-dashboard">
      <!-- HEADER TUTA & BARRERA -->
      <div class="app-header">
        <div class="logo-area">
          <div class="tuta-icon"><i data-lucide="crown"></i> TUTA</div>
          <div class="barrera-icon"><i data-lucide="zap"></i> BARRERA</div>
          <div class="logo-text"><h1>estudio en equipo</h1></div>
        </div>
        <div class="action-bar">
          <span class="badge"><i data-lucide="flame"></i> <span id="streakDisplay">0</span> racha</span>
          <span class="badge"><i data-lucide="zap"></i> nivel <span id="levelDisplay">1</span></span>
          <span class="badge"><i data-lucide="star"></i> <span id="pointsDisplay">0</span> pts</span>
          <div class="glass-button" id="themeToggle"><i data-lucide="moon"></i> tema</div>
        </div>
      </div>

      <!-- ESTAD√çSTICAS -->
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-title"><i data-lucide="check-circle"></i> completadas</div><div class="stat-value" id="completedCount">0</div><div class="progress-micro"><div class="progress-micro-fill" id="globalProgressBar"></div></div></div>
        <div class="stat-card"><div class="stat-title"><i data-lucide="list"></i> total tareas</div><div class="stat-value" id="totalTasks">0</div></div>
        <div class="stat-card"><div class="stat-title"><i data-lucide="layers"></i> materia activa</div><div class="stat-value" style="font-size:1.2rem;" id="subjectProgressText">‚ö° 0%</div><div class="progress-micro"><div class="progress-micro-fill" id="subjectProgressFill"></div></div></div>
        <div class="stat-card"><div class="stat-title"><i data-lucide="gift"></i> logro</div><div class="stat-value" style="font-size:1.2rem;" id="rewardBadge">üî∞ aprendices</div></div>
      </div>

      <!-- FILTROS -->
      <div class="search-filter-row">
        <div class="search-box"><i data-lucide="search"></i><input type="text" id="searchInput" placeholder="Buscar tarea..."></div>
        <select class="filter-select" id="filterSubject">
          <option value="*">Todas las materias</option>
          <option value="Matem√°ticas">üìê Mate con Tuta</option>
          <option value="F√≠sica">‚ö° F√≠sica con Barrera</option>
          <option value="Castellano">üìñ Tuta escribe</option>
          <option value="Bioqu√≠mica">üß¨ Barrera explica</option>
          <option value="Filosof√≠a">ü§î Tuta filosofa</option>
          <option value="Ingl√©s">üåé Barrera traduce</option>
          <option value="Taller">üõ†Ô∏è Taller de Tuta</option>
          <option value="Baloncesto">üèÄ Baloncesto con Barrera</option>
        </select>
      </div>

      <!-- INPUT TAREAS -->
      <div class="task-input-panel">
        <select id="materiaSelect">
          <option>Matem√°ticas</option><option>F√≠sica</option><option>Castellano</option><option>Bioqu√≠mica</option>
          <option>Filosof√≠a</option><option>Ingl√©s</option><option>Taller</option><option>Baloncesto</option>
        </select>
        <input type="text" id="taskInput" placeholder="Nombre de la tarea">
        <input type="date" id="dateInput">
        <button id="addTaskBtn"><i data-lucide="plus"></i> crear</button>
      </div>

      <!-- MENSAJE MOTIVACIONAL -->
      <div class="motivation-box" id="motivationMsg">
        <i data-lucide="message-circle"></i>
        <span>üß¢ Tuta dice: √âchale ganas, mi Barrera.</span>
      </div>

      <!-- LISTA DE TAREAS -->
      <div id="tasksList" class="tasks-container"></div>

      <!-- CHAT TUTA & BARRERA (CORREGIDO) -->
      <div class="chat-section">
        <div class="chat-title">
          <i data-lucide="message-square" width="24" style="color: var(--accent-tuta);"></i>
          <i data-lucide="message-square" width="24" style="color: var(--accent-barrera);"></i>
          <h3>Chat del d√∫o ¬∑ tiempo real</h3>
        </div>
        <div id="chatContainer" class="chat-container">
          <!-- mensajes din√°micos -->
        </div>
        <div class="chat-input-area">
          <select id="chatSender">
            <option value="Tuta">üß¢ Tuta</option>
            <option value="Barrera">‚ö° Barrera</option>
          </select>
          <input type="text" id="chatInput" placeholder="Escribe un mensaje..." maxlength="200">
          <button id="sendChatBtn"><i data-lucide="send"></i> enviar</button>
        </div>
      </div>

      <!-- SPOTIFY PLAYER (oficial) -->
      <div class="spotify-player">
        <iframe class="spotify-embed" src="https://open.spotify.com/embed/playlist/37i9dQZF1DXcF6B6QPhFDv?utm_source=generator&theme=0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
      </div>

      <!-- RECOMPENSA VIRTUAL -->
      <div style="text-align: right; color: var(--text-secondary); margin-top: 15px; font-size:0.9rem;" id="virtualRewardLine">‚≠ê pr√≥ximo nivel: 100 pts</div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js';
    import { getDatabase, ref, push, onValue, update, remove } from 'https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD8Z8M5TL-SU3oMFYULFaIzhBrD9yObXwo",
      authDomain: "papucholangas.firebaseapp.com",
      databaseURL: "https://papucholangas-default-rtdb.firebaseio.com",
      projectId: "papucholangas",
      storageBucket: "papucholangas.firebasestorage.app",
      messagingSenderId: "392558100266",
      appId: "1:392558100266:web:eb3a5313670bcafba96853"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const tasksRef = ref(db, 'tareas');
    const chatRef = ref(db, 'chat');

    // LOGIN
    const loginScreen = document.getElementById('loginScreen');
    const appContainer = document.getElementById('app');
    const passwordInput = document.getElementById('passwordInput');
    const loginBtn = document.getElementById('loginBtn');

    function checkPassword() {
      if (passwordInput.value === 'Papucholangas') {
        loginScreen.style.display = 'none';
        appContainer.style.display = 'block';
        initParticles();
        setupFirebaseListeners();
        confettiCanvas.width = window.innerWidth;
        confettiCanvas.height = window.innerHeight;
      } else {
        alert('Contrase√±a incorrecta');
      }
    }
    loginBtn.addEventListener('click', checkPassword);
    passwordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') checkPassword(); });

    // VARIABLES GLOBALES
    let allTasks = [];
    let userLevel = 1, userPoints = 0, streak = 0, lastCompletedDate = '';
    
    // Elementos DOM
    const tasksDiv = document.getElementById('tasksList');
    const totalSpan = document.getElementById('totalTasks');
    const completedSpan = document.getElementById('completedCount');
    const streakSpan = document.getElementById('streakDisplay');
    const levelSpan = document.getElementById('levelDisplay');
    const pointsSpan = document.getElementById('pointsDisplay');
    const globalBar = document.getElementById('globalProgressBar');
    const motMsg = document.getElementById('motivationMsg');
    const rewardLine = document.getElementById('virtualRewardLine');
    const subjectProgressText = document.getElementById('subjectProgressText');
    const subjectProgressFill = document.getElementById('subjectProgressFill');
    const searchInput = document.getElementById('searchInput');
    const filterSubject = document.getElementById('filterSubject');
    const addBtn = document.getElementById('addTaskBtn');
    const taskInput = document.getElementById('taskInput');
    const materiaSelect = document.getElementById('materiaSelect');
    const dateInput = document.getElementById('dateInput');
    const themeBtn = document.getElementById('themeToggle');
    
    // Chat elementos
    const chatContainer = document.getElementById('chatContainer');
    const chatSender = document.getElementById('chatSender');
    const chatInput = document.getElementById('chatInput');
    const sendChatBtn = document.getElementById('sendChatBtn');
    
    // Confetti
    const confettiCanvas = document.getElementById('confettiCanvas');
    let confettiCtx = confettiCanvas.getContext('2d');
    let particles = [];
    const sound = document.getElementById('taskSound');
    const chatSound = document.getElementById('chatSound');

    // ===== FUNCIONES =====
    function startConfetti() {
      confettiCanvas.style.display = 'block';
      for (let i=0; i<60; i++) particles.push({ x: Math.random()*window.innerWidth, y: -20, r: Math.random()*6+2, d: Math.random()*5+2, color: `hsl(${Math.random()*360},80%,60%)` });
      requestAnimationFrame(drawConfetti);
      setTimeout(() => { confettiCanvas.style.display = 'none'; particles = []; }, 2000);
    }
    function drawConfetti() {
      if (!confettiCanvas.style.display || confettiCanvas.style.display === 'none') return;
      confettiCtx.clearRect(0,0,window.innerWidth,window.innerHeight);
      particles.forEach(p => { p.y += p.d; if(p.y>window.innerHeight) p.y=-10; });
      particles.forEach(p => { confettiCtx.beginPath(); confettiCtx.arc(p.x, p.y, p.r, 0, Math.PI*2); confettiCtx.fillStyle = p.color; confettiCtx.fill(); });
      requestAnimationFrame(drawConfetti);
    }

    function updateStreak(tasks) {
      const today = new Date().toDateString().split(' ')[1]+' '+new Date().getDate();
      const completedToday = tasks.filter(t => t.hecho && t.completedDate === today).length;
      if (completedToday > 0) {
        if (lastCompletedDate !== today) { streak++; lastCompletedDate = today; }
      } else {
        const yesterday = new Date(Date.now()-864e5).toDateString().split(' ')[1]+' '+ (new Date(Date.now()-864e5).getDate());
        if (lastCompletedDate && lastCompletedDate !== today && lastCompletedDate !== yesterday) streak = 0;
      }
      streakSpan.innerText = streak;
    }

    function updateLevelAndPoints(completedDelta = 0) {
      if (completedDelta > 0) userPoints += 10 * completedDelta;
      let newLevel = Math.floor(userPoints / 100) + 1;
      if (newLevel > userLevel) {
        userLevel = newLevel;
        startConfetti();
        const levelMessages = ['aprendices', 'compas', 'dupla', 'leyendas', 'inmortales'];
        motMsg.innerHTML = `<i data-lucide="message-circle"></i><span>üéâ SUBIERON A NIVEL ${userLevel} ¬∑ ${levelMessages[Math.min(userLevel-1,4)]} üî•</span>`;
        lucide.createIcons();
      }
      levelSpan.innerText = userLevel;
      pointsSpan.innerText = userPoints;
    }

    // RENDER TAREAS
    function renderTasks(tasks) {
      allTasks = [...tasks];
      const searchTerm = searchInput.value.toLowerCase();
      const subjectFilter = filterSubject.value;
      let filtered = tasks.filter(t => t.texto.toLowerCase().includes(searchTerm));
      if (subjectFilter !== '*') filtered = filtered.filter(t => t.materia === subjectFilter);
      
      const total = filtered.length;
      const completed = filtered.filter(t => t.hecho).length;
      totalSpan.innerText = total;
      completedSpan.innerText = completed;
      const percent = total ? (completed/total)*100 : 0;
      globalBar.style.width = percent + '%';

      const subjectCounts = {};
      tasks.forEach(t => { if(!t.hecho) subjectCounts[t.materia] = (subjectCounts[t.materia]||0)+1; });
      const topSubject = Object.keys(subjectCounts).sort((a,b)=>subjectCounts[b]-subjectCounts[a])[0] || 'Ninguna';
      const totalSubj = tasks.filter(t=>t.materia===topSubject).length;
      const doneSubj = tasks.filter(t=>t.materia===topSubject && t.hecho).length;
      const subPercent = totalSubj? (doneSubj/totalSubj*100).toFixed(1):0;
      subjectProgressText.innerText = `${topSubject}: ${subPercent}%`;
      subjectProgressFill.style.width = subPercent + '%';

      // Mensajes con personalidad Tuta/Barrera
      const tutaMsgs = ['üß¢ Tuta: √©chale ganas', 'üß¢ Tuta: ¬øya merito?', 'üß¢ Tuta: yo conf√≠o en ti'];
      const barreraMsgs = ['‚ö° Barrera: vamos bien', '‚ö° Barrera: un paso m√°s', '‚ö° Barrera: t√∫ puedes'];
      const random = Math.floor(Math.random() * 3);
      motMsg.innerHTML = `<i data-lucide="message-circle"></i><span>${Math.random()>0.5 ? tutaMsgs[random] : barreraMsgs[random]}</span>`;
      lucide.createIcons();

      const rewards = ['üî∞ aprendices', '‚ö° compas', 'üî• dupla', 'üíé leyendas', 'üèÜ inmortales'];
      rewardLine.innerText = `üéÅ ${rewards[Math.min(userLevel-1,4)]} ¬∑ pr√≥ximo en ${100 - (userPoints%100)}pts`;

      tasksDiv.innerHTML = filtered.map(t => {
        const dateStr = t.fecha ? new Date(t.fecha).toLocaleDateString() : 'sin fecha';
        return `<div class="task-card ${t.hecho ? 'completed' : ''}" data-key="${t.key}">
          <div class="task-info">
            <div class="task-title"><span class="badge-materia">${t.materia}</span> ${t.texto}</div>
            <div class="task-meta"><span><i data-lucide="calendar" width="12"></i> ${dateStr}</span></div>
          </div>
          <div class="task-actions">
            <button class="icon-btn complete-btn" data-key="${t.key}" data-done="${t.hecho}"><i data-lucide="${t.hecho ? 'rotate-ccw' : 'check'}"></i></button>
            <button class="icon-btn edit-btn" data-key="${t.key}" data-text="${t.texto}"><i data-lucide="pencil"></i></button>
            <button class="icon-btn delete-btn" data-key="${t.key}"><i data-lucide="trash-2"></i></button>
          </div>
        </div>`;
      }).join('');
      lucide.createIcons();

      // Eventos botones tarea
      document.querySelectorAll('.complete-btn').forEach(b => b.addEventListener('click', (e) => {
        e.stopPropagation();
        const key = b.dataset.key; const done = b.dataset.done === 'true';
        update(ref(db, 'tareas/'+key), { hecho: !done });
        if (!done) {
          sound.play().catch(e=>{}); startConfetti();
          const today = new Date().toDateString().split(' ')[1]+' '+new Date().getDate();
          update(ref(db, 'tareas/'+key), { completedDate: today });
          updateLevelAndPoints(1);
        }
      }));
      
      document.querySelectorAll('.delete-btn').forEach(b => b.addEventListener('click', (e) => {
        e.stopPropagation();
        remove(ref(db, 'tareas/'+b.dataset.key));
      }));
      
      document.querySelectorAll('.edit-btn').forEach(b => b.addEventListener('click', (e) => {
        e.stopPropagation();
        const newText = prompt('Editar tarea:', b.dataset.text);
        if (newText && newText.trim()) update(ref(db, 'tareas/'+b.dataset.key), { texto: newText.trim() });
      }));
    }

    // ===== FUNCIONES CHAT (CORREGIDAS) =====
    function renderChat(messages) {
      // Ordenar de m√°s antiguo a m√°s nuevo para mostrarlos correctamente
      const sorted = [...messages].sort((a, b) => a.timestamp - b.timestamp);
      chatContainer.innerHTML = sorted.map(msg => {
        const isTuta = msg.sender === 'Tuta';
        return `<div class="chat-message ${isTuta ? 'message-tuta' : 'message-barrera'}">
          <div class="message-bubble">
            <div class="message-sender">${isTuta ? 'üß¢ Tuta' : '‚ö° Barrera'}</div>
            <div class="message-text">${msg.text}</div>
            <div class="message-time">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
          </div>
        </div>`;
      }).join('');
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ENVIAR MENSAJE CHAT - Versi√≥n corregida
    sendChatBtn.addEventListener('click', () => {
      const text = chatInput.value.trim();
      if (!text) return;
      
      // Enviar a Firebase
      push(chatRef, {
        sender: chatSender.value,
        text: text,
        timestamp: Date.now()
      }).then(() => {
        chatInput.value = ''; // Limpiar solo despu√©s de enviar exitosamente
      }).catch(error => {
        console.error("Error enviando mensaje:", error);
        alert("No se pudo enviar el mensaje");
      });
    });

    // Tambi√©n enviar con Enter
    chatInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendChatBtn.click();
      }
    });

    // AGREGAR TAREA
    addBtn.addEventListener('click', () => {
      const texto = taskInput.value.trim();
      if (!texto) return;
      push(tasksRef, {
        texto,
        materia: materiaSelect.value,
        fecha: dateInput.value || null,
        hecho: false
      });
      taskInput.value = '';
    });

    // TEMA CLARO/OSCURO - CORREGIDO
    themeBtn.addEventListener('click', () => {
      document.body.classList.toggle('light');
      const icon = themeBtn.querySelector('i');
      if (document.body.classList.contains('light')) {
        icon.setAttribute('data-lucide', 'sun');
      } else {
        icon.setAttribute('data-lucide', 'moon');
      }
      lucide.createIcons();
    });

    // FILTROS
    searchInput.addEventListener('input', () => renderTasks(allTasks));
    filterSubject.addEventListener('change', () => renderTasks(allTasks));

    // ===== FIREBASE LISTENERS =====
    function setupFirebaseListeners() {
      // Escuchar tareas
      onValue(tasksRef, (snapshot) => {
        const tasks = [];
        snapshot.forEach(child => tasks.push({ key: child.key, ...child.val() }));
        tasks.sort((a,b) => (a.fecha||'') > (b.fecha||'') ? 1 : -1);
        renderTasks(tasks);
        updateStreak(tasks);
      });

      // Escuchar chat - Versi√≥n corregida
      onValue(chatRef, (snapshot) => {
        const msgs = [];
        snapshot.forEach(child => {
          msgs.push({ 
            key: child.key, 
            ...child.val() 
          });
        });
        renderChat(msgs);
        if (msgs.length > 0) {
          chatSound.play().catch(e => console.log("Sound error:", e));
        }
      });
    }

    // AJUSTES DE PANTALLA
    window.addEventListener('resize', () => { 
      confettiCanvas.width = window.innerWidth; 
      confettiCanvas.height = window.innerHeight; 
    });

    function initParticles() {
      particlesJS('particles-js', {
        particles: { 
          number: { value: 50 }, 
          color: { value: '#4a80f0' }, 
          opacity: { value: 0.25 }, 
          size: { value: 2.5 }, 
          line_linked: { enable: true, distance: 150, color: '#4a80f0', opacity: 0.15 }, 
          move: { enable: true, speed: 0.6 } 
        },
        interactivity: { 
          detect_on: 'canvas', 
          events: { onhover: { enable: true, mode: 'repulse' } } 
        }
      });
    }

    // Inicializar iconos
    lucide.createIcons();
  </script>
</body>
</html>
